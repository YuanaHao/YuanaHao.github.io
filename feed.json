{
  "version": "https://jsonfeed.org/version/1.1",
  "title": "CS_Blog",
  "home_page_url": "https://newzone.top/",
  "feed_url": "https://newzone.top/feed.json",
  "description": "算法学习, 计算机公开课博客分享平台。",
  "favicon": "https://newzone.top/favicon.ico",
  "items": [
    {
      "title": "PA -- A new journey for the OS",
      "url": "https://newzone.top/posts/PA.html",
      "id": "https://newzone.top/posts/PA.html",
      "summary": "This blog will begin from the half of PA1 Because I thought \"STFW\" can solve the problems before. I have to confirm that I have install the Ubuntu 22.04 for my CS task, so I loo...",
      "content_html": "<blockquote>\n<p>This blog will begin from the half of PA1\nBecause I thought \"STFW\" can solve the problems before.\nI have to confirm that I have install the Ubuntu 22.04 for my CS task, so I look through the PA0 in a fast way.</p>\n</blockquote>\n<h2>PA1 The simplest computer</h2>\n<h3>infrastructure</h3>\n<blockquote>\n<p>There always exist infrastructure where exist codes.</p>\n</blockquote>\n<p>The course build a significant infrainstructure called <code>Simple Debugger</code>(sdb) in the NEMU.</p>\n<p>NEMU is regarded as a programm to excute other guest programm which means NEMU can know all information of the guest programm.</p>\n<p>However, the information is hard to be caught by the debugger out of the NEMU, such as GDB.(set a breakpoint by GDB for the guest programm is also hard)</p>\n<p>Inorder to improve the efficiency of debugging, we need to build a simple Debugger at the monitor.</p>\n<p>Below are the format and functions:<br>\n|instruction|format|example|explanation|\n|</p>\n",
      "date_published": "2024-12-26T00:00:00.000Z",
      "date_modified": "2024-12-30T14:07:26.000Z",
      "authors": [],
      "tags": [
        "计算机体系结构"
      ]
    },
    {
      "title": "ASC2025 TEST_0_CONCURRENCY",
      "url": "https://newzone.top/posts/0_REPORT.html",
      "id": "https://newzone.top/posts/0_REPORT.html",
      "summary": "How to find the bugs in the program reference: https://nj.gitbooks.io/c/content/content/chapter10/chapter10-chinese.html parallel problem bugs unnecessary block dead lock live l...",
      "content_html": "<h2>How to find the bugs in the program</h2>\n<blockquote>\n<p>reference: https://nj.gitbooks.io/c/content/content/chapter10/chapter10-chinese.html</p>\n</blockquote>\n<h3>parallel problem bugs</h3>\n<h4>unnecessary block</h4>\n<ul>\n<li>dead lock</li>\n<li>live lock(condition not met)</li>\n<li>I/O block</li>\n</ul>\n<h4>conditional competition</h4>\n<ul>\n<li>data race</li>\n<li>destroy constant</li>\n<li>life circle issues</li>\n</ul>\n<h3>how to find bugs</h3>\n<ul>\n<li>read codes</li>\n<li>set breakpoint</li>\n<li>use tools</li>\n</ul>\n<h2>how did I find bugs in the pro</h2>\n<p>below steps are tying to test a progect when i didn't know if there were bugs.</p>\n<h3>step1: try to run the code and monitor the output</h3>\n<p>We can compile the code to a executable file by the instruction in the terminal, just a try.</p>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">gcc</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> condvar.cc</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> -o</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> try</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> -pthread</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> -lstdc++</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div></div></div><p>then run \"try\", the output is \"error: data[0] = 718613\".</p>\n<p>so we can confirm there are some bugs in the codes, then try to find them.</p>\n<p>we need to use some tools, such as <code>ThreadSanitizer</code>, to confirm the specific issue type.</p>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">g++</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> condvar.cc</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> -fsanitize=thread</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> -fPIE</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> -pie</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> -g</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> -o</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> TSan</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div></div></div><p>then run the \"TSan\"</p>\n<p>the output is \"WARNING: ThreadSanitizer: data race (pid=30965)\". so we can confirm there exist \"data race\" issue. then read codes to try to find if not \"join()\" or \"condition variable\" are here.</p>\n<p></p>\n<h3>step2: read the codes and understand the brief frame</h3>\n<ul>\n<li>\"create_func\" is a lambda expression and define the tasks of each thread.\n<ol>\n<li>wait \"m_waiting\" to start work</li>\n<li>fetch a task, decrease the waiting task count</li>\n<li>thread of array position += 1</li>\n<li>one thread finish the task then notify the main thread by \"notify_one()\"</li>\n</ol>\n</li>\n<li>the first \"for circle\" is set to creat the threads</li>\n<li>the second \"for circle\" is set to finish the main thread's task\n<ol>\n<li>update the waiting task count and notify all threads to start working</li>\n<li>wait for all threads to finish and clear the finished task count, enter the next round</li>\n</ol>\n</li>\n<li>the last \"for circle\" is set to check.</li>\n</ul>\n<h3>step3: set some log information</h3>\n<p>if we are back to the step1, you will find seem \"warning\" is after the data check, meaning we can't find the data error, so we must set some log information.</p>\n<p>I choice to set the below codes.</p>\n<div class=\"language-cpp line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"cpp\" data-title=\"cpp\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">// run 1000000 rounds</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    for</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 1000000</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; i</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">        // update the waiting task count</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        lock </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">lk_waiting</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(m_waiting);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        waiting </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 5</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#ABB2BF\">        std</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">::</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">fill</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">worktime</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">begin</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(), </span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">worktime</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">end</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(), </span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">true</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">        // notify all threads to start working</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">        cv_waiting</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">notify_all</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">();</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">        lk_waiting</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">unlock</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">();</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">        // wait for all threads to finish</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        lock </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">lk_finished</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(m_finished);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">        cv_finished</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">wait</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(lk_finished, []() { </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">return</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> finished </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">==</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 5</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; });</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">        // clear the finished task count, enter the next round</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        finished </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">        lk_finished</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">unlock</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">();</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        </span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">        // log information</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">        printf</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"finish </span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">%d</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">  %d</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> %d</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> %d</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> %d</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> %d</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">\\n</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">, i, </span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">data</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">], </span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">data</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">1</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">], </span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">data</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">2</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">], </span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">data</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">3</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">], </span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">data</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">4</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">]);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    }</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>after recompile and run it again, I found suprisely the five data sum up to <code>5000000</code>, but one of them was not <code>1000000</code>.</p>\n<p>the answer is found out, threads of the task didn't work balancedly, some time some threads may work more than one time in one circle, so we just need to make sure just once.</p>\n<h2>how did I fix the bugs</h2>\n<h3>step1: fix unbalanced work</h3>\n<p>I choice to introduce a new condition variable <code>worktime</code> for 5 threads, to make sure just work one time in one circle.</p>\n<div class=\"language-cpp line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"cpp\" data-title=\"cpp\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">vec_t</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&lt;</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">bool</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">worktime</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">5</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">, </span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">);</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div></div></div><p>then I add them into every threads as a judgement for starting to get work.</p>\n<div class=\"language-cpp line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"cpp\" data-title=\"cpp\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">auto</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> create_func </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> [](</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> tid</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        return</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> [</span><span style=\"--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">tid</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">]() {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">            while</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">true</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">                // wait for the signal to start working or exit</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">                lock </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">lk_waiting</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(m_waiting);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">                // add worktime</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">                cv_waiting</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">wait</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(lk_waiting, [</span><span style=\"--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">tid</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">]() { </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">return</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> waiting </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#56B6C2\"> &amp;&amp;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\"> worktime</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[tid] </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#56B6C2\">||</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\"> exit_flag</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">load</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(); });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">                if</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">exit_flag</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">load</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">() </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#56B6C2\">&amp;&amp;</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#56B6C2\"> !</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">worktime</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[tid]) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">                    break</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">                }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">                if</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">worktime</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[tid]) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">                    // fetch a task, decrease the waiting task count</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">                    waiting</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">--</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">                    worktime</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[tid] </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> false</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">                    lk_waiting</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">unlock</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">();</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">                    </span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">                    // do the work</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">                    data</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[tid] </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">+=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 1</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">                    // increase the finished task count</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">                    lock </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">lk_finished</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(m_finished);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">                    finished</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">                    cv_finished</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">notify_one</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">();</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">                    lk_finished</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">unlock</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">();</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">                }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">            }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        };</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    };</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>and update the worktime at the beginning of every circle.</p>\n<div class=\"language-cpp line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"cpp\" data-title=\"cpp\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">for</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 1000000</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; i</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">        // update the waiting task count</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        lock </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">lk_waiting</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(m_waiting);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        waiting </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 5</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">        //update the worktime</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#ABB2BF\">        std</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">::</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">fill</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">worktime</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">begin</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(), </span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">worktime</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">end</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(), </span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">true</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">        // notify all threads to start working</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">        cv_waiting</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">notify_all</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">();</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">        lk_waiting</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">unlock</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">();</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">        // wait for all threads to finish</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        lock </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">lk_finished</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(m_finished);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">        cv_finished</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">wait</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(lk_finished, []() { </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">return</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> finished </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">==</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 5</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; });</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">        // clear the finished task count, enter the next round</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        finished </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">        lk_finished</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">unlock</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">();</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">        printf</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"finish </span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">%d</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">  %d</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> %d</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> %d</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> %d</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> %d</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">\\n</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">, i, </span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">data</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">], </span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">data</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">1</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">], </span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">data</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">2</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">], </span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">data</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">3</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">], </span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">data</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">4</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">]);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    }</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>then we can get <code>check passed!</code></p>\n<p></p>\n<h3>step2: exit sucessfully</h3>\n<p>this issue is easy to find out the reason, we can see it in the \"WARNING: ThreadSanitizer: data race (pid=30965)\".</p>\n<p>By analysing the warning, we can easily find the issue occur when the main thread finished and try to destroy the global variables, but other threads are using them.</p>\n<p>so we just need to use a variable to notify the thread to stop and use join() function to let main thread wait other threads.</p>\n<div class=\"language-cpp line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"cpp\" data-title=\"cpp\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">// notify the thread to stop</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">    exit_flag</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">store</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">true</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">    cv_waiting</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">notify_all</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">();</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">// use join() to wait</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">for</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">auto</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#56B6C2\"> &amp;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">t : threads) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        if</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">t </span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">-&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">joinable</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">()) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">            t </span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">-&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">join</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">();</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        delete</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> t;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    }</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>then we can exit sucessfully!</p>\n<p>check passed!</p>\n<h2>my answer</h2>\n<div class=\"language-cpp line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"cpp\" data-title=\"cpp\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">/*</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> * This task has 5 threads, each thread will increase the corresponding element</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> * in the data vector by 1. The main thread will run 1000000 rounds, in each</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> * round, it will notify all threads to start working, and wait for all threads</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> * to finish.</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> *</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> * After 1000000 rounds, the main thread will check if all elements in the</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> * data vector are 1000000.</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> *</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> * 1. Find the bug in the code, and fix it.</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> * 2. The code can bot exit normally, fix it, ensure all working threads are</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> * finished before the main thread exit.</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> *</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> */</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;condition_variable&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;cstdio&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;cstdlib&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;mutex&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;thread&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;vector&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;atomic&gt;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">using</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#ABB2BF\"> std</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">::mutex;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">using</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#ABB2BF\"> std</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">::thread;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">using</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#E5C07B\"> lock</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> =</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#ABB2BF\"> std</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">::</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#E5C07B\">unique_lock</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&lt;</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#ABB2BF\">std</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">::</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#E5C07B\">mutex</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt;;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">using</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#E5C07B\"> condvar_t</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> =</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#ABB2BF\"> std</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">::</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#E5C07B\">condition_variable</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">template</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> &lt;</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">typename</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#E5C07B\"> T</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">using</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#E5C07B\"> vec_t</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> =</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#ABB2BF\"> std</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">::</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#E5C07B\">vector</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&lt;</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#E5C07B\">T</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt;;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">mutex m_waiting;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">mutex m_finished;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">mutex m_workonce;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">condvar_t</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> cv_waiting;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">condvar_t</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> cv_finished;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">condvar_t</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> cv_workonce;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#ABB2BF\">std</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">::</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#E5C07B\">atomic</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&lt;</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">bool</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">exit_flag</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#E5C07B\">false</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> waiting </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> finished </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">// the data to be processed</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">vec_t</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&lt;</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">data</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">5</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">, </span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">vec_t</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&lt;</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">bool</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">worktime</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">5</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">, </span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">auto</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> main</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">() -&gt; </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">    vec_t</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">thread</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*&gt;</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> threads</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">5</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    auto</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> create_func </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> [](</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> tid</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        return</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> [</span><span style=\"--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">tid</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">]() {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">            while</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">true</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">                // wait for the signal to start working or exit</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">                lock </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">lk_waiting</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(m_waiting);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">                cv_waiting</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">wait</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(lk_waiting, [</span><span style=\"--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">tid</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">]() { </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">return</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> waiting </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#56B6C2\"> &amp;&amp;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\"> worktime</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[tid] </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#56B6C2\">||</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\"> exit_flag</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">load</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(); });</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">                if</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">exit_flag</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">load</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">() </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#56B6C2\">&amp;&amp;</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#56B6C2\"> !</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">worktime</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[tid]) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">                    break</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">                }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">                if</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">worktime</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[tid]) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">                    // fetch a task, decrease the waiting task count</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">                    waiting</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">--</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">                    worktime</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[tid] </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> false</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">                    lk_waiting</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">unlock</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">();</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">                    </span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">                    // do the work</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">                    data</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[tid] </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">+=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 1</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">                    // increase the finished task count</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">                    lock </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">lk_finished</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(m_finished);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">                    finished</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">                    cv_finished</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">notify_one</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">();</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">                    lk_finished</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">unlock</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">();</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">                }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">            }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        };</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    };</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    for</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 5</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; i</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">        threads</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[i] </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> new</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> thread</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">create_func</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(i));</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">    // run 1000000 rounds</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    for</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 1000000</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; i</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">        // update the waiting task count</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        lock </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">lk_waiting</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(m_waiting);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        waiting </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 5</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#ABB2BF\">        std</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">::</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">fill</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">worktime</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">begin</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(), </span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">worktime</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">end</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(), </span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">true</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">        // notify all threads to start working</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">        cv_waiting</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">notify_all</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">();</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">        lk_waiting</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">unlock</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">();</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">        // wait for all threads to finish</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        lock </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">lk_finished</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(m_finished);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">        cv_finished</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">wait</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(lk_finished, []() { </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">return</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> finished </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">==</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 5</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; });</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">        // clear the finished task count, enter the next round</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        finished </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">        lk_finished</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">unlock</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">();</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">        printf</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"finish </span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">%d</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">  %d</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> %d</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> %d</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> %d</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> %d</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">\\n</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">, i, </span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">data</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">], </span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">data</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">1</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">], </span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">data</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">2</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">], </span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">data</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">3</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">], </span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">data</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">4</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">]);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">    exit_flag</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">store</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">true</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">    cv_waiting</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">notify_all</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">();</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    for</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">auto</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#56B6C2\"> &amp;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">t : threads) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        if</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">t </span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">-&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">joinable</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">()) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">            t </span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">-&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">join</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">();</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        delete</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> t;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">    // check, all element in data should be 1000000</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    for</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 5</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; i</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        if</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">data</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[i] </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">!=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 1000000</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">            printf</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"error: data[</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">%d</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">] = </span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">%d</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">\\n</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">, i, </span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">data</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[i]);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">            return</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 1</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">    printf</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"check passed</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">\\n</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    return</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">}</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div>",
      "date_published": "2024-12-15T00:00:00.000Z",
      "date_modified": "2024-12-16T05:33:42.000Z",
      "authors": [],
      "tags": [
        "ASC"
      ]
    },
    {
      "title": "ASC2025 TEST_1_cluster",
      "url": "https://newzone.top/posts/1_REPORT.html",
      "id": "https://newzone.top/posts/1_REPORT.html",
      "summary": "Installation it's easy to finish the envirment settings, so I just talk about some issues occuered. step1: unzip the baseenv.tar.gz may the .tar.gz file be unziped to many files...",
      "content_html": "<h2>Installation</h2>\n<p>it's easy to finish the envirment settings, so I just talk about some issues occuered.</p>\n<h3>step1: unzip the <code>baseenv.tar.gz</code></h3>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">tar</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> -xvf</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> baseenv.tar.gz</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div></div></div><blockquote>\n<p>may the .tar.gz file be unziped to many files. my solution is packing them in a new .tar file by <code>tar cvf bassenv.tar bassenv</code>.</p>\n</blockquote>\n<p>then we can get the package <code>baseenv.tar</code>.</p>\n<h3>step2: Load the Docker image from the .tar file</h3>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">docker</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> load</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> -i</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> baseenv.tar</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div></div></div><h3>step3: start the container with the following command</h3>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">#node1</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">docker</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> run</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> -it</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> --cap-add</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> NET_ADMIN</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> --name</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> node1</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> baseenv:latest</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> /bin/bash</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">#node2</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">docker</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> run</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> -it</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> --cap-add</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> NET_ADMIN</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> --name</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> node2</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> baseenv:latest</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> /bin/bash</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>However, if we want to make sure <code>not connect to the internet from the container</code>, we can use the below instruction:</p>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">#node1</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">docker</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> run</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> -it</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> --cap-add</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> NET_ADMIN</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> --sysctl</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> net.bridge.bridge-nf-call-iptables=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">0</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> --name</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> node1</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> baseenv:latest</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> /bin/bash</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><blockquote>\n<p>reference: https://cloud.tencent.com/developer/article/2335144</p>\n</blockquote>\n<p>this allows us to access intranet but not to access the Internet in the container.</p>\n<h2>task</h2>\n<h3>task1: compile the <code>mpich</code></h3>\n<blockquote>\n<p>reference: https://blog.csdn.net/u014185088/article/details/121482116</p>\n</blockquote>\n<p>after create the continer, we can <code>cd root</code> and ues <code>ls</code> to find the <code>mpich-4.3.0b1</code>, then unzip it.</p>\n<h4>step1: set mpich configure and make it</h4>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">cd</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> mpich-4.3.0b1</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"># use --disable-fortran to ban the fortran setting</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">./configure</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> --prefix=/root/mpich</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> --disable-fortran</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"># make it</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">make</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> &amp;&amp; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">make</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> install</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>then set PATH:</p>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">vim</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> ~/.bashrc</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"># write</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">export</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E06C75\"> MPIPATH</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#56B6C2\">=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">/</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E06C75\">root</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">/</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E06C75\">mpich</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">export</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E06C75\"> MPIPATHBIN</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#56B6C2\">=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E06C75\">$MPIPATH</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">/</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E06C75\">bin</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">export</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E06C75\"> MPIPATHINCLUDE</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#56B6C2\">=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E06C75\">$MPIPATH</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">/</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E06C75\">include</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">export</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E06C75\"> MPIPATHLIB</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#56B6C2\">=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E06C75\">$MPIPATH</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">/</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E06C75\">lib</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">export</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E06C75\"> MPIPATHSHARE</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#56B6C2\">=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E06C75\">$MPIPATH</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">/</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E06C75\">share</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">export</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E06C75\"> PATH</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#56B6C2\">=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E06C75\">$PATH</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">:</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E06C75\">$MPIPATHBIN</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">:</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E06C75\">$MPIPATHINCLUDE</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">:</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E06C75\">$MPIPATHLIB</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">:</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E06C75\">$MPIPATHSHARE</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>then we can see the <code>mpicc</code> version:</p>\n<p></p>\n<p>let's try a mpi programm in a continer.</p>\n<p>I copy a <code>test.cpp</code> from the Internet.</p>\n<div class=\"language-cpp line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"cpp\" data-title=\"cpp\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;stdio.h&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;mpich/mpi.h&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;string.h&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;stdlib.h&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;math.h&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;time.h&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">&lt;omp.h&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">&lt;iostream&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">using</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> namespace</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#E5C07B\"> std</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">//生成随机矩阵</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> *</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">generate_matrix</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> size</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">{</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">\tsrand</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">((</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">unsigned</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">time</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">NULL</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">+</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">unsigned</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">rand</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">());</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\tint</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> *</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">matrix;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\tmatrix </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> *</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">malloc</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">sizeof</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> size</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\tfor</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> size</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size; i</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\t{</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">\t\tmatrix</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[i] </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> rand</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">() </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">%</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 10</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\t}</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\treturn</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> matrix;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">}</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">//输出矩阵</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">void</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> print_matrx</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> *</span><span style=\"--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">a</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">, </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> size</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">{</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\tfor</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> size; i</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\t{</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\t\tfor</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> j </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; j </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> size; j</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\t\t{</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">\t\t\tprintf</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">%d</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> \"</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">, </span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">a</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[i</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">+</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> j]);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\t\t}</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">\t\tprintf</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">\\n</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\t}</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">\tprintf</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">\\n</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">}</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">//矩阵相乘</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> *</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> Multiplication</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> a</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[], </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> b</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[], </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> size</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">, </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> line</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">{</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\tint</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> *</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">result;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\tint</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> temp </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\tresult </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> *</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">malloc</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">sizeof</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> size</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">//#pragma omp parallel for num_threads(2)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\tfor</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> line; i</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\t{</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\t\tfor</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> j </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; j </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> size; j</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\t\t{</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\t\t\ttemp </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\t\t\tfor</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> k </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; k </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> size; k</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\t\t\t\ttemp </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">+=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\"> a</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[i</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">+</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> k] </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\"> b</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[k</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">+</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> j];</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">\t\t\tresult</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[i</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">+</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> j] </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> temp;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\t\t}</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\t}</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\treturn</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> result;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">}</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> main</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> argc</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">, </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">char</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> *</span><span style=\"--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">argv</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[])</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">{</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\tclock_t</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> time1, time2;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\tint</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> size </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 16</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">, rank, line, num;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\ttime1 </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> clock</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">();</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">\tMPI_Init</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#56B6C2\">&amp;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">argc, </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#56B6C2\">&amp;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">argv);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">\tMPI_Comm_rank</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(MPI_COMM_WORLD, </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#56B6C2\">&amp;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">rank);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">\tMPI_Comm_size</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(MPI_COMM_WORLD, </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#56B6C2\">&amp;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">num);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\tint</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> *</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">matrix1;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\tint</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> *</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">matrix2;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\tint</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> *</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">matrix3;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\tint</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> *</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">resultMg;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\tint</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> *</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">revMg;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\tint</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> *</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">resultMg0;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\tline </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> size </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">/</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> num ;</span><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">  //num为进程数，line为每个进程的行数</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\tmatrix1 </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">malloc</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">sizeof</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\tmatrix2 </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">malloc</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">sizeof</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\tmatrix3 </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">malloc</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">sizeof</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\tresultMg </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">malloc</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">sizeof</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">line);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\tresultMg0 </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">malloc</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">sizeof</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">line);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\trevMg </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">malloc</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">sizeof</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">line);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\tif</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (rank </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">==</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\t{</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\t\tmatrix1 </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> generate_matrix</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(size);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\t\tmatrix2 </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> generate_matrix</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(size);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">\t\tprintf</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"matrix1 is :</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">\\n</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">\t\tprint_matrx</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">((</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> *</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)matrix1, size);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">\t\tprintf</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"matrix2 is :</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">\\n</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">\t\tprint_matrx</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">((</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> *</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)matrix2, size);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\t\tresultMg0</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">Multiplication</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(matrix1,matrix2, size, line);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\t\tfor</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> m </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; m </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> line; m</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\t\t\tfor</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> n </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; n </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> size; n</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">\t\t\t\tmatrix3</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[m</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">+</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> n] </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\"> resultMg0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[m</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">+</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> n];</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\t\tfor</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 1</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> num; i</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">\t\t\tMPI_Send</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(matrix2, size</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size, MPI_INT, i, </span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">, MPI_COMM_WORLD);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\t\tfor</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 1</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> num; i</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">\t\t\tMPI_Send</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(matrix1 </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">+</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> i</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">line</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size, size</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">line, MPI_INT, i, </span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">1</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">, MPI_COMM_WORLD);</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\t\tfor</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 1</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> num; i</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\t\t{</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">\t\t\tMPI_Recv</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(resultMg, line</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size, MPI_INT, i, </span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">3</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">, MPI_COMM_WORLD, MPI_STATUS_IGNORE);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\t\t\tfor</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> m </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; m </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> line; m</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\t\t\t\tfor</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> n </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; n </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> size; n</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">\t\t\t\t\tmatrix3</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[(i</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">line </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">+</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> m)</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">+</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> n] </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\"> resultMg</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[m</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">+</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> n];</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\t\t}</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\t\ttime2 </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> clock</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">();</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">\t\tprint_matrx</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">((</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> *</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)matrix3, size);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\t\tcout </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> time2 </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">-</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> time1 </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> endl;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">\t\tfree</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(matrix1);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">\t\tfree</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(matrix2);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">\t\tfree</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(matrix3);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">\t\tfree</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(revMg);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">\t\tfree</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(resultMg);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\t}</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\telse</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">\t\tMPI_Recv</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(matrix2, size</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size, MPI_INT, </span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">, </span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">, MPI_COMM_WORLD, MPI_STATUS_IGNORE);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">\t\tMPI_Recv</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(revMg, size</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">line, MPI_INT, </span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">, </span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">1</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">, MPI_COMM_WORLD, MPI_STATUS_IGNORE);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\t\tresultMg </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> Multiplication</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(revMg, matrix2, size, line);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">\t\tMPI_Send</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(resultMg, line</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">*</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">size, MPI_INT, </span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">, </span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">3</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">, MPI_COMM_WORLD);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">\t}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">\tMPI_Finalize</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">();</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">\treturn</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">}</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>then use the below instruction copy the code to the continer.</p>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">docker</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> cp</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> /media/user/Data/biancheng/code/ASC/ASC_2025/test/optimize-tasks/1.cluster/test.cpp</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> node1:/root</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div></div></div><p>try to compile the <code>test.cpp</code>.</p>\n<p></p>\n<p>oops, we seem to need to use the <code>absolute address</code>.</p>\n<div class=\"language-cpp line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"cpp\" data-title=\"cpp\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">// fix the code</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;mpich/mpi.h&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">// right code</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> \"/root/mpich/include/mpi.h\"</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>then we can find <code>mpi</code></p>\n<p></p>\n<p>run the programm</p>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">mpiexec</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> -n</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 4</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> ./mpi</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div></div></div><p></p>\n<p>check passed!</p>\n<h3>task2: configure the network for containers</h3>\n<p>creat a new net for continers</p>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">docker</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> network</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> create</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> cluster</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div></div></div><p></p>\n<p>and add the node1 &amp; node2 into the net.</p>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">docker</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> network</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> connect</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> cluster</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> node1</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">docker</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> network</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> connect</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> cluster</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> node2</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>then try to ping node2 from node1.</p>\n<p></p>\n<p>check passed!</p>\n<h4>task3: configure ssh for the containers</h4>\n<p>Firstly, we need to set a password for ssh.</p>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">passwd</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div></div></div><p>my password is set to <code>asc2025</code>.</p>\n<p>we need to change the <code>PermitRootLogin prohibit-password</code> to <code>PermitRootLogin yes</code>, and change port from <code>22</code> to <code>8080</code>.</p>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">vim</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> /etc/ssh/sshd_config</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div></div></div><p>use <code>docker commit</code> to build a new image.</p>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">docker</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> commit</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> -m</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> 'ssh'</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> -a</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> 'node1:ssh'</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> node1</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">  node1:ssh</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div></div></div><p>then use the new image to build two new nodes to set port.</p>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">docker</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> run</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> -it</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> -d</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> -p8088:8080</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> --cap-add</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> NET_ADMIN</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> --sysctl</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> net.bridge.bridge-nf-call-iptables=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">0</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> --name</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> node1_ssh</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> node1:ssh</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> /bin/bash</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div></div></div><p>start the new continer, and start the ssh.</p>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">/usr/sbin/sshd</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div></div></div><p>then we can use password to connect with the continer from the host.</p>\n<p></p>\n<p>then we can try to login in the node1 from node2.</p>\n<p></p>\n<p>check passed!</p>\n<h4>task4: run the MPI program in the cluster</h4>\n<p>then we can use a test programm to test the connection.</p>\n<div class=\"language-c line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"c\" data-title=\"c\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> \"/root/mpich/include/mpi.h\"</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> </span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;stdio.h&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> </span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;math.h&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> </span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> main</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> argc</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">,</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> char</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> *</span><span style=\"--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">argv</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">[]</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">{</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">  int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> myid, numprocs; </span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">  int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> namelen;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">  char</span><span style=\"--shiki-light:#E36209;--shiki-dark:#E06C75\"> processor_name</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[MPI_MAX_PROCESSOR_NAME]; </span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">  MPI_Init</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&amp;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">argc,</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&amp;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">argv);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">  MPI_Comm_rank</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(MPI_COMM_WORLD,</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&amp;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">myid); </span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">  MPI_Comm_size</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(MPI_COMM_WORLD,</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&amp;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">numprocs); </span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">  MPI_Get_processor_name</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(processor_name,</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&amp;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">namelen);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">  fprintf</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(stderr,</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"Hello World! Process </span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">%d</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> of </span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">%d</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> on </span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">%s</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">\\n</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">, myid, numprocs, processor_name);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">  MPI_Finalize</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">();</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">}</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p></p>\n<p>we can change the name of the container from the host configure, just I didn't do it.</p>\n<p>check passed!</p>\n<blockquote>\n<p>tips: the container should exist the <code>hello</code> and the environment of the MPI.</p>\n</blockquote>\n",
      "date_published": "2024-12-15T00:00:00.000Z",
      "date_modified": "2024-12-16T05:33:42.000Z",
      "authors": [],
      "tags": [
        "ASC"
      ]
    },
    {
      "title": "Diffusion（文生图、文生视频）推理服务",
      "url": "https://newzone.top/posts/%E6%96%87%E7%94%9F%E5%9B%BE.html",
      "id": "https://newzone.top/posts/%E6%96%87%E7%94%9F%E5%9B%BE.html",
      "summary": "文生图 随着transformer在文本生成方面逐步展现出的巨大潜力和ChatGPT等生成式对话AI的逐步商业化, 处理多模态任务的价值也不断被挖掘, 文生图 文生视频等潜力巨大的任务类型开始提上研究日程. 但是同生成式对话使用有限的文本量便能达成较为不错的生成效果不同, 文生视频和文生图任务由于图形任务的整体性对大块内存的使用提出了更为严苛的要求, ...",
      "content_html": "<h2>文生图</h2>\n<p>随着transformer在文本生成方面逐步展现出的巨大潜力和ChatGPT等生成式对话AI的逐步商业化, 处理多模态任务的价值也不断被挖掘, <code>文生图</code> <code>文生视频</code>等潜力巨大的任务类型开始提上研究日程.</p>\n<p>但是同生成式对话使用有限的文本量便能达成较为不错的生成效果不同, 文生视频和文生图任务由于图形任务的整体性对大块内存的使用提出了更为严苛的要求, 图块与图块 像素与像素之间的高度关联性也难以像文本推理一样通过简单的切分矩阵实现并发, 这使得最为常用的 <code>Diffusion</code>模型在生成时长和内存占用上的表现都差强人意.</p>\n<p>文生图 文生视频等多模态任务中的分布式推理服务就是在这种背景下被关注的.</p>\n<p>目前考虑到的针对Diffusion的优化主要集中于以下几个方面:</p>\n<ul>\n<li>使用更好的solver, 减少采样步数, 避免多轮采样带来的内存开销</li>\n<li>利用diffusion相邻step冗余考虑适当保存activate值, 避免不必要的重计算</li>\n<li>使用diffusion parallelism</li>\n<li>使用一些通用优化手段,像算子并行,图优化,模型压缩等等.</li>\n</ul>\n<h3>DistriFusion</h3>\n<p><code>https://openaccess.thecvf.com/content/CVPR2024/papers/Li_DistriFusion_Distributed_Parallel_Inference_for_High-Resolution_Diffusion_Models_CVPR_2024_paper.pdf</code></p>\n<p><code>https://github.com/mit-han-lab/distrifuser</code></p>\n<blockquote>\n<p>2024的CVPR, 工作属于是Diffusion parallelsim的一种</p>\n</blockquote>\n<h4>特点</h4>\n<ul>\n<li>无需训练</li>\n<li>加速效果较好, 可以达到6倍以上加速</li>\n<li>利用了diffusion过程相邻步之间feature map的相似性</li>\n</ul>\n<h4>以往方法</h4>\n<p></p>\n<p><code>常规方法</code>: 多GPU通常仅用于批量推理. 在生成单张图像时，通常只涉及一个GPU.考虑到激活值规模庞大, 通信成本会超过分布式计算带来的节省, 张量并行等并行技术并不适合diffusion模型.</p>\n<p><code>传统分批方法</code>: 将图像split成N个patch，放在N个device上进行推理，然后将N个device的结果合成为一个全分辨率的结果.<br>\n但是这种方法由于缺少各个patch间的信息感知，会生成N个小图拼接而成的大图, 边界处会出现明显的接缝, 区块间引入交互又会带来过高的同步成本</p>\n<blockquote>\n<p>用精度换效率, 但是图片不是整体了, 这也是前言讲难以像文本推理一样通过简单的切分矩阵实现并行的原因</p>\n</blockquote>\n<h4>相关工作</h4>\n<p>difussion核心在迭代去噪点生成内容, 用巨量的计算换取极高的生成能力, 目前优化主要集中在以下几点:</p>\n<ul>\n<li>高效去噪: 如将高分辨率图像压缩为低分辨率的潜在表示，并在潜在空间中学习扩散模型</li>\n<li>设计无需训练的高效采样算法: 基于扩散模型与微分方程之间的联系，并利用成熟的指数积分器来减少采样步骤</li>\n<li>预训练的扩散模型中提炼出生成模型: 成效不佳</li>\n<li>优化扩散模型的神经推理</li>\n<li>DistriFusion方法: 利用多个设备上的神经网络并行性来加速扩散过程</li>\n</ul>\n<p></p>\n<p>针对LLM的并行方法特点是: LLM模型尺寸较大, 但激活尺寸小, 不需要引入太多通讯开销.</p>\n<p>但difussion模型的特点是: 模型尺寸较小, 但激活尺寸大, 于是通信开销不得不成为主要矛盾, 目前主要只使用数据并行.</p>\n<p>本文方法基于patch并行性, 切分小patch分到不同设备处理, 倾向于使用AllGather而非AllReduce进行数据交互.</p>\n<h4>背景知识</h4>\n<p>扩散模型通常会训练一个噪声预测神经网络模型（如U-Net）<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>ϵ</mi><mi>θ</mi></msub></mrow><annotation encoding=\"application/x-tex\">ϵ_{θ}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5806em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">ϵ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">θ</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>.<br>\n从纯高斯噪声<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>x</mi><mi>T</mi></msub><mo>∼</mo><mi>N</mi><mo stretchy=\"false\">(</mo><mn>0</mn><mo separator=\"true\">,</mo><mi>I</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">x_{T} ∼ N(0, I)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5806em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3283em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">T</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">∼</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mopen\">(</span><span class=\"mord\">0</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mclose\">)</span></span></span></span>开始，该模型需要经过数十到数百次的迭代去噪步骤，以获得最终的清晰图像<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>x</mi><mn>0</mn></msub></mrow><annotation encoding=\"application/x-tex\">x_{0}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5806em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">0</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，其中T表示总步数.<br>\n在时间步t给定含噪图像<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>x</mi><mi>t</mi></msub></mrow><annotation encoding=\"application/x-tex\">x_{t}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5806em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2806em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>，模型<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>ϵ</mi><mi>θ</mi></msub></mrow><annotation encoding=\"application/x-tex\">ϵ_{θ}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5806em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">ϵ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">θ</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>会将<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>x</mi><mi>t</mi></msub></mrow><annotation encoding=\"application/x-tex\">x_{t}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5806em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2806em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>、t以及额外的条件c（例如文本）作为输入，以预测<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>x</mi><mi>t</mi></msub></mrow><annotation encoding=\"application/x-tex\">x_{t}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5806em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2806em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>中的相应噪声<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>ϵ</mi><mi>t</mi></msub></mrow><annotation encoding=\"application/x-tex\">ϵ_{t}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5806em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">ϵ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2806em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>.<br>\n在每个去噪步骤中，可以通过以下方程推导出<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>x</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msub></mrow><annotation encoding=\"application/x-tex\">x_{t-1}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6389em;vertical-align:-0.2083em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2083em;\"><span></span></span></span></span></span></span></span></span></span>:</p>\n<p v-pre=\"\" class=\"katex-block\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><msub><mi mathvariant=\"bold\">x</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>=</mo><mrow><mi mathvariant=\"normal\">U</mi><mi mathvariant=\"normal\">p</mi><mi mathvariant=\"normal\">d</mi><mi mathvariant=\"normal\">a</mi><mi mathvariant=\"normal\">t</mi><mi mathvariant=\"normal\">e</mi></mrow><mo stretchy=\"false\">(</mo><msub><mi mathvariant=\"bold\">x</mi><mi>t</mi></msub><mo separator=\"true\">,</mo><mi>t</mi><mo separator=\"true\">,</mo><msub><mi>ϵ</mi><mi>t</mi></msub><mo stretchy=\"false\">)</mo><mo separator=\"true\">,</mo><mspace width=\"1em\"></mspace><msub><mi>ϵ</mi><mi>t</mi></msub><mo>=</mo><msub><mi>ϵ</mi><mi>θ</mi></msub><mo stretchy=\"false\">(</mo><msub><mi mathvariant=\"bold\">x</mi><mi>t</mi></msub><mo separator=\"true\">,</mo><mi>t</mi><mo separator=\"true\">,</mo><mi>c</mi><mo stretchy=\"false\">)</mo><mi mathvariant=\"normal\">.</mi></mrow><annotation encoding=\"application/x-tex\">\n\\mathbf{x}_{t-1}=\\mathrm{Update}(\\mathbf{x}_t,t,\\epsilon_t),\\quad\\epsilon_t=\\epsilon_\\theta(\\mathbf{x}_t,t,c). \n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6528em;vertical-align:-0.2083em;\"></span><span class=\"mord\"><span class=\"mord mathbf\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2083em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathrm\">Update</span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathbf\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2806em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">ϵ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2806em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">ϵ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2806em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">ϵ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">θ</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathbf\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2806em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mclose\">)</span><span class=\"mord\">.</span></span></span></span></span></p>\n<p>通过这个公式我们可以轻易发现<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>x</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msub></mrow><annotation encoding=\"application/x-tex\">{x}_{t-1}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6389em;vertical-align:-0.2083em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span><span class=\"mbin mtight\">−</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2083em;\"><span></span></span></span></span></span></span></span></span></span>和<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>x</mi><mi>t</mi></msub></mrow><annotation encoding=\"application/x-tex\">{x}_{t}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5806em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\">x</span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2806em;\"><span style=\"top:-2.55em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>的强依赖关系, 这给<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6151em;\"></span><span class=\"mord mathnormal\">t</span></span></span></span>与<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">t-1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6984em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span>步的模型<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding=\"application/x-tex\">ϵ</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">ϵ</span></span></span></span>并行带来了极大的困难.</p>\n<p>同时本文还指出, 处理一张1024x1024的图像时，每步需要6,763 <code>GMACs（十亿次乘加运算）</code>。随着分辨率的增加，这种计算需求会以超过二次方的速度增加，导致生成单张高分辨率图像的延迟在实际应用中变得过高.</p>\n<blockquote>\n<p>作者还在这里cue了一下Shih等人在2023提出的ParaDiGMS, 说利用Picard迭代以数据并行的方式并行化去噪步骤, 是可能存在无效结果的&amp;步数较大的去噪方式, 难以并行加速.\n这篇文章也是NeurIPS 2023的一篇, 平均加速在2倍左右, 的确没有本文出色.</p>\n</blockquote>\n<p>本文又一次强调了模型分片到多个设备上，并使用张量并行进行推理的大通讯量的不可行性.</p>\n<h4>本文方法</h4>\n<ul>\n<li>将图像分割成多个区块，在多个设备间并行化处理计算, 这存在两个选择和两个问题:\n<ol>\n<li>独立计算各个区块并随后拼接 -&gt; 边界处会出现明显的接缝和强烈的撕裂感</li>\n<li>区块间同步传递中间激活信息 -&gt; 极高的通信开销, 甚至超过计算时间</li>\n</ol>\n</li>\n</ul>\n<p>为解决上述问题, 本文提出了一种新的并行范式--<code>位移区块并行</code>.</p>\n<p><code>核心</code>:利用前一步扩散过程中稍有过时或“陈旧”的激活信息，来促进区块间的交互.</p>\n<p>在计算某一区块某一层的激活信息时，并不依赖于其他区块的最新激活信息，从而使得通信可以被隐藏在后续层的计算过程中.</p>\n<blockquote>\n<p>两次扩散时间步的图相似度是很高的, 确实有相当一部分激活值完全可以\"暂存\"而不用\"重计算\"或者\"通讯\".</p>\n</blockquote>\n<h5>位移补丁并行</h5>\n<p></p>\n<p>在预测<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>ϵ</mi><mi>θ</mi></msub><mo stretchy=\"false\">(</mo><msub><mi>x</mi><mi>t</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">ϵ_{θ}(x_{t})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">ϵ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">θ</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2806em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span>（为简化说明，此处省略了时间步<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6151em;\"></span><span class=\"mord mathnormal\">t</span></span></span></span>和条件<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi></mrow><annotation encoding=\"application/x-tex\">c</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.4306em;\"></span><span class=\"mord mathnormal\">c</span></span></span></span>的输入）时，首先将<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>x</mi><mi>t</mi></msub></mrow><annotation encoding=\"application/x-tex\">x_{t}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5806em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2806em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>分割成多个补丁<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mi>x</mi><mi>t</mi><mrow><mo stretchy=\"false\">(</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow></msubsup></mrow><annotation encoding=\"application/x-tex\">x_{t}^{(1)}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.2906em;vertical-align:-0.2458em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.0448em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span><span style=\"top:-3.2198em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mopen mtight\">(</span><span class=\"mord mtight\">1</span><span class=\"mclose mtight\">)</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span></span></span></span>, <span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mi>x</mi><mi>t</mi><mrow><mo stretchy=\"false\">(</mo><mn>2</mn><mo stretchy=\"false\">)</mo></mrow></msubsup></mrow><annotation encoding=\"application/x-tex\">x_{t}^{(2)}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.2906em;vertical-align:-0.2458em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.0448em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span><span style=\"top:-3.2198em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mopen mtight\">(</span><span class=\"mord mtight\">2</span><span class=\"mclose mtight\">)</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span></span></span></span>, ..., <span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mi>x</mi><mi>t</mi><mrow><mo stretchy=\"false\">(</mo><mi>N</mi><mo stretchy=\"false\">)</mo></mrow></msubsup></mrow><annotation encoding=\"application/x-tex\">x_{t}^{(N)}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.2906em;vertical-align:-0.2458em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.0448em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span><span style=\"top:-3.2198em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mopen mtight\">(</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">N</span><span class=\"mclose mtight\">)</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span></span></span></span>，其中N表示设备的数量. 在例图使用了N=2.每个设备都拥有模型<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>ϵ</mi><mi>θ</mi></msub></mrow><annotation encoding=\"application/x-tex\">ϵ_{θ}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5806em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">ϵ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">θ</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>的一个副本，并将独立且并行地处理一个单独的补丁.上标(1)和(2)分别代表第一个和第二个块，前一步的陈旧激活被加深了颜色.</p>\n<p>在每一步<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6151em;\"></span><span class=\"mord mathnormal\">t</span></span></span></span>，首先将输入<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>x</mi><mi>t</mi></msub></mrow><annotation encoding=\"application/x-tex\">x_{t}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.5806em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2806em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>分割成N个块<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mi>x</mi><mi>t</mi><mrow><mo stretchy=\"false\">(</mo><mn>1</mn><mo stretchy=\"false\">)</mo></mrow></msubsup></mrow><annotation encoding=\"application/x-tex\">x_{t}^{(1)}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.2906em;vertical-align:-0.2458em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.0448em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span><span style=\"top:-3.2198em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mopen mtight\">(</span><span class=\"mord mtight\">1</span><span class=\"mclose mtight\">)</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span></span></span></span>, <span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mi>x</mi><mi>t</mi><mrow><mo stretchy=\"false\">(</mo><mn>2</mn><mo stretchy=\"false\">)</mo></mrow></msubsup></mrow><annotation encoding=\"application/x-tex\">x_{t}^{(2)}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.2906em;vertical-align:-0.2458em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.0448em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span><span style=\"top:-3.2198em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mopen mtight\">(</span><span class=\"mord mtight\">2</span><span class=\"mclose mtight\">)</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span></span></span></span>, ..., <span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mi>x</mi><mi>t</mi><mrow><mo stretchy=\"false\">(</mo><mi>N</mi><mo stretchy=\"false\">)</mo></mrow></msubsup></mrow><annotation encoding=\"application/x-tex\">x_{t}^{(N)}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.2906em;vertical-align:-0.2458em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.0448em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span><span style=\"top:-3.2198em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mopen mtight\">(</span><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10903em;\">N</span><span class=\"mclose mtight\">)</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span></span></span></span>，对于每一层l和每个设备i，在获取输入激活块<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mi>A</mi><mi>t</mi><mrow><mi>l</mi><mo separator=\"true\">,</mo><mo stretchy=\"false\">(</mo><mi>i</mi><mo stretchy=\"false\">)</mo></mrow></msubsup></mrow><annotation encoding=\"application/x-tex\">A_{t}^{l,(i)}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.2906em;vertical-align:-0.2458em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.0448em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span><span style=\"top:-3.2198em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mpunct mtight\">,</span><span class=\"mopen mtight\">(</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mclose mtight\">)</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span></span></span></span>之后，将执行两个异步操作：</p>\n<ol>\n<li>在设备 i 上，<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mi>A</mi><mi>t</mi><mrow><mi>l</mi><mo separator=\"true\">,</mo><mo stretchy=\"false\">(</mo><mi>i</mi><mo stretchy=\"false\">)</mo></mrow></msubsup></mrow><annotation encoding=\"application/x-tex\">A_{t}^{l,(i)}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.2906em;vertical-align:-0.2458em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.0448em;\"><span style=\"top:-2.4542em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span><span style=\"top:-3.2198em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span><span class=\"mpunct mtight\">,</span><span class=\"mopen mtight\">(</span><span class=\"mord mathnormal mtight\">i</span><span class=\"mclose mtight\">)</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2458em;\"><span></span></span></span></span></span></span></span></span></span>被重新分散回前一步的陈旧激活<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mi>A</mi><mi>t</mi><mi>l</mi></msubsup></mrow><annotation encoding=\"application/x-tex\">A_{t}^{l}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0961em;vertical-align:-0.247em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8491em;\"><span style=\"top:-2.453em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span></span></span></span>.这个Scatter操作的输出随后被输入到稀疏操作<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>F</mi><mi>l</mi></msub></mrow><annotation encoding=\"application/x-tex\">F_{l}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>中（线性、卷积或注意力层），它仅在新鲜区域上执行计算并产生相应的输出.</li>\n<li>与此同时，对A_{t}^{l,(i)}执行AllGather操作，以准备下一步的完整激活<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mi>A</mi><mi>t</mi><mi>l</mi></msubsup></mrow><annotation encoding=\"application/x-tex\">A_{t}^{l}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0961em;vertical-align:-0.247em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8491em;\"><span style=\"top:-2.453em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.01968em;\">l</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span></span></span></span>.</li>\n</ol>\n<p>最后，将最终输出聚合在一起，以近似<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>ϵ</mi><mi>θ</mi></msub><mo stretchy=\"false\">(</mo><msub><mi>x</mi><mi>t</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">ϵ_{θ}(x_{t})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">ϵ</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">θ</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">x</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2806em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">t</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></p>\n<h4>总结</h4>\n<p>DistriFusion是一种利用多GPU并行加速扩散模型的新方法.将图像分割成多个区块，并将每个区块分配给独立的GPU进行处理.同时复用前一步骤的预计算激活值，以保持区块间的相互作用.</p>\n<p>局限:</p>\n<ol>\n<li>对于低分辨率图像，DistriFusion的加速效果有限.</li>\n<li>对于步数极少的方法，由于去噪状态迅速变化，该方法可能不适用.</li>\n</ol>\n<h3>PipeFusion</h3>\n<p><code>https://arxiv.org/html/2405.14430v2</code></p>\n<blockquote>\n<p>PipeFusion可以看作是在DistriFusion上的改进与推广, 重点是把DistriFusion方法移植到了DiT模型上, 证明了DistriFusion方法的泛用性.</p>\n</blockquote>\n<h4>摘要</h4>\n<p>PipeFusion通过将图像分割成多个patch并跨多个GPU分布网络层，采用流水线并行方式来协调通信和计算.</p>\n<p>利用相邻扩散步骤输入之间的高相似性，通过复用一步旧的特征图来为当前步骤提供上下文，从而消除流水线中的等待时间</p>\n<h4>问题</h4>\n<ul>\n<li>DiT模型的推理延迟显著，随着序列长度的增加，计算时间呈二次方增长.单GPU无法满足实际应用的延迟要求，需要跨多个计算设备并行化DiT推理.</li>\n<li>DistriFusion需要为每个GPU维护所有层的KV数据，导致GPU增加时内存开销增加.</li>\n<li>DistriFusion基于U-NET模型，在每个layer上做集合通信，通信开销较大.</li>\n</ul>\n<h4>本文方法</h4>\n<blockquote>\n<p>和DistriFusion相同操作如patch分割, 异步修正, warmup预热不再赘述</p>\n</blockquote>\n<p></p>\n<p>PipeFusion与DistriFusion不同的是:</p>\n<ol>\n<li>采用流水线并行方式来协调不同设备上的计算和通信, 但保存原本激活值的方式和DistriFusion保持一致</li>\n<li>采用P2P通信, 考虑DiT模型特点, 不再像DistriFusion每个时间步的通信都是Scatter给每个设备, 而是点对点通信, 减少通信成本</li>\n<li>提升存储效率, 与DistriFusion相比，PipeFusion每个设备只存储与其特定阶段相关的参数的1/N.</li>\n</ol>\n<h3>xDIT</h3>\n<p>DiT模型在文生图和文生视频等表现出了杰出的性能, 但是与此同时DiTs 的输入序列长度日益增长，序列增长导致Attention 机制的计算量也随之呈平方级膨胀, 推理延迟极为严重, 单卡推理必然无法满足需求, 多GPU乃至多机DiT部署是必然要求.</p>\n<p>但是在之前都是基于hf diffusers库进行改造, 正如在vLLM前都是基于hf transformer进行改造, 都是临时的不成体系的方案, 迫切需求一个性能好且易用性高的DiT推理框架.</p>\n<p>于是, 在PipeFusion基础上升级的xDit诞生了.</p>\n<p><code>https://arxiv.org/abs/2405.14430</code></p>\n<p><code>https://github.com/xdit-project/xDiT</code></p>\n<p>DiT 和 LLM 推理任务特点不同, 改进思路也不同:</p>\n<ol>\n<li>LLM 有 Prefill 和 Decode 两阶段，分别是compute boundary和memory boundary的; 而DiT 的计算和 Prefill 相似是compute boundary的.</li>\n<li>LLM 模型很大，而序列长度有限(虽然现在长文本需求也在增加);而 DiT 正好反过来，模型不大，推理时序列长度很长, TP的适用性较低.</li>\n<li>LLM 模型大多收敛到微调 Llama 架构, 但DiT架构则呈现出较大差异性, 框架统一难度较大.</li>\n</ol>\n<p>考虑到 DiT 的特点，本文提出一系列混合并行方式, 提供了一套优雅的开发接口，针对性解决了 DiT 模型更改难度高的问题，这套开发接口尽可能可能复用 diffusers 的现有逻辑，开发者通过一些 wrapper 实现复杂的混合并行，实现高效地扩展方法.</p>\n<p></p>\n<h4>Overview</h4>\n<h5>DiT 主干网络混合并行</h5>\n<p>xDiT支持四种基础并行策略<code>以任何形式混合</code>, <code>达到近似线性效果</code>:</p>\n<ol>\n<li>Pipefusion Parallel</li>\n<li>Sequence Parallel</li>\n<li>Data Parallel</li>\n<li>CFG Parallel <code>https://arxiv.org/abs/2207.12598</code></li>\n</ol>\n<h5>Parallel VAE</h5>\n<p>针对扩散模型后处理的解码 VAE 模块 (解码器模块)在高分辨率图像生成时 OOM (Out Of Memory)问题，xDiT 实现了 Patch Parallel 版本的 VAE.</p>\n<h5>简单灵活的开发接口</h5>\n<h4>PipeFusion</h4>\n<p>见前文</p>\n<h4>USP：混合序列并行</h4>\n<p>见<code>MLSys_分布式开发（选读）</code> DeepSpeed-Ulysses部分</p>\n<h4>CFG Parallel</h4>\n<p>Classifier-Free Guidance（CFG）是扩散模型领域的一个重要的技巧，可以提供更广泛的条件控制、减少训练负担、增强生成内容的质量和细节，以及提高模型的实用性和适应性.</p>\n<p>一个输入 prompt，使用 CFG 需要同时进行 unconditional guide 和 text guide 的生成, 就是DistriFusion 中的 split batch.</p>\n<h4>Hybrid Parallel</h4>\n<p>xDiT 设计目标是扩展 DiT 推理过程到超大规模, 实现多机多卡, 不同并行方式混合在一起变得尤为重要.</p>\n<p>PipeFusion 和 Sequence 在图像内部的不同 Patch 间并行则较为复杂, 两种并行方式的混合使用，是 xDiT 核心创新点之一.</p>\n<p>PipeFusion利用过时的KV进行Attention计算，这使得PipeFusion无法像大型语言模型（LLM）那样轻松地实现并行策略的混合, 以pipe_degree=4，sp_degree=2的混合并行方法为例:</p>\n<p></p>\n<p>标准 SP Attention实现，输入Q，K，V和输出O都是沿着序列维度切分，且切分方式一致。如果不同rank的输入patch没有重叠，每个micro step计算出fresh KV更新的位置在不同rank间也没有重叠.</p>\n<p>如下图所示，standard SP的KV Buffer中黄色部分是SP0 rank=0拥有的fresh KV，绿色部分是SP1 rank=1拥有的fresh KV，二者并不相同.</p>\n<p>在这个diffusion step内，device=0无法拿到P1,3,5,7的fresh KV进行计算，但是PipeFusion则需要在下一个diffusion step中，拥有上一个diffusion step全部的KV(保留旧有激活值避免大量通讯).</p>\n<p>standard SP只拥有1/sp_degree的fresh kv buffer，因此无法获得混合并行推理正确的结果.</p>\n<p></p>\n<p>xDiT专门定制了序列并行的实现方式，以适应这种混合并行的需求.</p>\n<p>xDiT使用<code>xFuserLongContextAttention</code>把SP的中间结果存在KV Buffer内.</p>\n<p>效果如下图，每个micro-step SP执行完毕后，SP Group内不同rank设备的fresh KV是相互补充的.</p>\n<p>这样一个diffusion step后，SP Group所有设备的KV Buffer都更新成最新，供下一个Diffusion Step使用.</p>\n<p></p>\n<h4>Parallel VAE</h4>\n<p>VAE 模块在高清图片生成时, 会导致OOM(见<code>https://github.com/huggingface/diffusers/issues/5924</code>).</p>\n<p>在xDiT开发了 DistVAE解决了这个问题, 使用了两种关键策略:</p>\n<ol>\n<li>SP: 特征图分割成多个 Patch，并在不同设备上进行序列并行 VAE 解码, 中间激活所需的峰值内存减少到 1/N.</li>\n<li>分块输入处理: 输入特征图分割成块，并依次送入卷积运算符</li>\n</ol>\n",
      "date_published": "2024-12-07T00:00:00.000Z",
      "date_modified": "2024-12-16T11:49:36.000Z",
      "authors": [],
      "tags": [
        "SOSD"
      ]
    },
    {
      "title": "MLSys_分布式开发",
      "url": "https://newzone.top/posts/AISys_%E5%88%86%E5%B8%83%E5%BC%8F.html",
      "id": "https://newzone.top/posts/AISys_%E5%88%86%E5%B8%83%E5%BC%8F.html",
      "summary": "为什么AI需要分布式系统 什么是分布式系统 分布式系统顾名思义，就是将单一计算机节点要做的任务分布在多个计算机节点上完成的，各个节点之间通过网络进行通讯的计算机系统。 这种系统的好处是显而易见的，我们可以把一台机器的Task进行切分，可能大幅度提升计算效率；我们可以把一台机器存不下的任务放到多个结点里面，拓展数据规模。 但同时也可能引入更多的问题，多台...",
      "content_html": "<h2>为什么AI需要分布式系统</h2>\n<h3>什么是分布式系统</h3>\n<p>分布式系统顾名思义，就是将单一计算机节点要做的任务<code>分布</code>在多个计算机节点上完成的，各个节点之间通过网络进行通讯的计算机系统。</p>\n<p>这种系统的好处是显而易见的，我们可以把一台机器的Task进行切分，可能大幅度<code>提升计算效率</code>；我们可以把一台机器存不下的任务放到多个结点里面，<code>拓展数据规模</code>。</p>\n<p>但同时也可能引入更多的问题，多台机器之间通讯耗费的时间会不会比原先计算的时间更长？切分后的任务如何再将结果重新合在一起？这些都问题都有进一步研究的价值。</p>\n<h3>为什么AI训练需要分布式系统</h3>\n<p>在训练AI时，无论在CV方向还是NLP等其他方向，无论使用哪一种模型，总是绕不开<code>训练集</code>和<code>测试集</code>这两部分，我们总要拿出一部分数据用来预训练模型，另一部分用来测试模型效果。</p>\n<p><code>数据集越大，训练效果越好</code>，这基本上是在不考虑机器性能上限的情况下，我们针对AI训练达成的一种共识，所以在训练AI时我们希望能使用尽可能大的数据集，使用尽可能多的参数，来对尽可能多的标签进行刻画。但可惜一台机器的性能总是有限的。</p>\n<p>这个时候就不得不引入<code>分布式系统</code>来改善这种局面了，如果我们一台机器、一张GPU/TPU没办法高效完成我们的运算，那我们可以分到多张卡上面；如果我们一台机器存储不开我们的数据集，那我们可以分到多台设备上，或者考虑让CPU也存储一部分模型数据。这就是AI使用分布式系统想要解决的问题。</p>\n<h2>分布式系统如何发挥作用</h2>\n<h3>数据分布式的一些基本想法</h3>\n<p>如果我们希望分布式系统在AI训练中发挥他的力量，我们要怎么做呢？大家都对ML有一些基本的认识了，无论哪一种模型，在训练过程中总会有数据（输入、输出），模型（参数、激活函数）等等需要保存的东西。</p>\n<p>现在假定我们要做一个训练任务，我们有我们自己的很大的<code>数据集</code>，我希望能把这个数据<code>很快的训练完</code>，那我们就可以考虑把数据<code>切分</code>成好几份，然后给<code>不同的GPU</code>去算每一个单独的部分，这种每个一份数据切分成多份，给不同的GPU做计算的方式，但每一个GPU均做<code>保留完整的模型</code>做计算，被我们称作<code>数据并行（Data Patallel，简称DP）</code>。</p>\n<p>既然可能有很大的<code>数据集</code>需要切分，那自然也可能有很大的<code>模型</code>进行切分，让每一个GPU仅保留<code>几个隐藏层的模型</code>（参数、激活函数），这样可以训练更大的模型，提升训练精度，这种按层切分模型，不切分数据的方式，被称作<code>模型并行（Model Patallel，简称MP）</code>。</p>\n<p>这种按层切分的方式固然可以增加可容纳的模型的大小，但是仅让一个卡存模型的几层在计算某些必须要用到之前的数据的模型时可能不尽如人意，通讯成本会比较高昂。</p>\n<p>为了解决层切分的弊端，我们可以考虑将计算过程中的算子/计算矩阵进行切分，让每一张卡只保留必须的参数和算子，产生部分输出，这样就可以将每一部分计算矩阵进行并发处理，我们将这种方式称作<code>张量并行/算子并行（Tensor Patallel，简称TP）</code>，谷歌专门为TP开发了TPU进行并发适配，TP也是应用较广的基本并发方式。</p>\n<p>既然我们有了对数据切分的方法，有了对模型算子切分的方法，那我们也可以考虑进行结合，既切分优化器状态，又切分模型的参数、梯度，这种并行方式被称作<code>完全分片数据并行（Fully Sharded Data Parallel，简称FSDP）</code>。</p>\n<p>前面所提及的方法，是在利用切分层内数据/优化器状态/模型绕过MP方法按层切分时可能带来的通讯瓶颈，但是也可以利用类似CPU指令流水线执行的方式，进行数据计算，切分模型让不同GPU延后计算开始时间，从而保证通讯无boundary，这种方式被称作<code>流水线并行（Pipe Parallel，简称PP）</code>。</p>\n<p>在探讨了DP、PP、TP基本并行方式后，我们可以考虑将三种并行方式进行综合，考虑一些综合利用并行方式的策略，这种并行考量被称为<code>3D并行</code>。</p>\n<p>事实上对于采用哪种并行模式，要用多少张卡进行并行，并行中使用的参数如何调整，是一件非常复杂的事情，我们期望有可以<code>自动为我们选定并行方法的策略</code>，这种策略被称作<code>自动并行</code>。</p>\n<h2>数据并行（DP）</h2>\n<h3>典型数据并行的流程</h3>\n<p></p>\n<p></p>\n<ul>\n<li>分配n块计算GPU（图中0-2）;1块梯度收集GPU</li>\n<li>每块GPU均拷贝一份完整的模型</li>\n<li>把一份Data（也可以是一个batch）切分成若干份给不同的GPU</li>\n<li>每一块GPU完成Forward和Backward后，计算出本地的梯度</li>\n<li>把本地梯度push到梯度收集GPU，梯度收集GPU聚合梯度</li>\n<li>计算GPU从聚合GPU中pull完整梯度，更新模型参数，保证各个计算GPU模型同步</li>\n</ul>\n<blockquote>\n<p>聚合再下发梯度操作被称为<code>AllReduce</code></p>\n</blockquote>\n<h3>Horovod</h3>\n<blockquote>\n<p>Horovod: fast and easy distributed deep learning in TensorFlow</p>\n</blockquote>\n<p><code>https://arxiv.org/abs/1802.05799</code> <code>https://github.com/uber/horovod</code></p>\n<p>传统的DP在带来使用大数据集可能的同时，又同时增加了额外的通讯开销，本文还指出DP代码重构成本较大。</p>\n<p>本文通过在不同数量卡上训练结果进行说明：<br>\n</p>\n<p>可以明显看到GPU数量增多时，TensorFlow框架下的通讯开销越大，在128卡时甚至已经超过训练开销。</p>\n<p>为了解决传统DP计算节点和聚合节点比例不好确定导致的通讯成本/计算成本过大的问题，本文指出了ring-allreduce的方式。</p>\n<h4>Ring-AllReduce</h4>\n<p>假设有4块GPU，每块GPU上的数据也对应被切成4份。AllReduce就是要让每块GPU上的数据都变成箭头右边汇总的样子。</p>\n<p></p>\n<p>Ring-AllReduce将这个过程分为<code>Reduce-Scatter</code>和<code>All-Gather</code>。</p>\n<h5>Reduce-Scatter</h5>\n<p>定义网络拓扑关系，使得每个GPU只和其<code>相邻的两块GPU通讯</code>。每次发送对应位置的数据进行累加。每一次累加更新都形成一个拓扑环。</p>\n<p></p>\n<p></p>\n<p></p>\n<p></p>\n<p>3次更新之后，每块GPU上都有一块数据拥有了对应位置完整的聚合（图中红色）。此时，Reduce-Scatter阶段结束。进入All-Gather阶段。目标是把红色块的数据广播到其余GPU对应的位置上。</p>\n<h5>All-Gather</h5>\n<p>相邻GPU对应位置进行通讯，对应位置数据不再做相加，而是直接替换</p>\n<p></p>\n<h4>Horovod工作</h4>\n<ul>\n<li>将百度的 TensorFlow ring-allreduce 算法的实现转化为一个独立的 Python 包，命名为 Horovod</li>\n<li>使用 NCCL 库实现了 TensorFlow ring-allreduce，并优化了性能</li>\n<li>添加了对单机多卡的支持</li>\n<li>改进了 API，添加 broadcast 操作，仅需 4 步即可使用 Horovod</li>\n</ul>\n<h4>使用方法</h4>\n<div class=\"language- line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"\" data-title=\"\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span>import tensorflow as tf</span></span>\n<span class=\"line\"><span>import horovod.tensorflow as hvd</span></span>\n<span class=\"line\"><span></span></span>\n<span class=\"line\"><span># 初始化 Horovod</span></span>\n<span class=\"line\"><span>hvd.init()</span></span>\n<span class=\"line\"><span></span></span>\n<span class=\"line\"><span># 固定 GPU 以处理本地 rank（每个进程一个 GPU）</span></span>\n<span class=\"line\"><span>config = tf.ConfigProto()</span></span>\n<span class=\"line\"><span>config.gpu_options.visible_device_list = str(hvd.local_rank())</span></span>\n<span class=\"line\"><span></span></span>\n<span class=\"line\"><span># 构建模型...</span></span>\n<span class=\"line\"><span>loss = ...</span></span>\n<span class=\"line\"><span>opt = tf.train.AdagradOptimizer(0.01)</span></span>\n<span class=\"line\"><span></span></span>\n<span class=\"line\"><span># 添加 Horovod 分布式优化器</span></span>\n<span class=\"line\"><span>opt = hvd.DistributedOptimizer(opt)</span></span>\n<span class=\"line\"><span></span></span>\n<span class=\"line\"><span># 添加hook，在初始化期间将变量从 rank 0 广播到所有其他进程</span></span>\n<span class=\"line\"><span>hooks = [hvd.BroadcastGlobalVariablesHook(0)]</span></span>\n<span class=\"line\"><span></span></span>\n<span class=\"line\"><span># 创建训练操作</span></span>\n<span class=\"line\"><span>train_op = opt.minimize(loss)</span></span>\n<span class=\"line\"><span></span></span>\n<span class=\"line\"><span># MonitoredTrainingSession 负责会话初始化、从检查点恢复、保存到检查点以及在完成或发生错误时关闭</span></span>\n<span class=\"line\"><span>with tf.train.MonitoredTrainingSession(checkpoint_dir=\"/tmp/train_logs\",</span></span>\n<span class=\"line\"><span>                                       config=config,</span></span>\n<span class=\"line\"><span>                                       hooks=hooks) as mon_sess:</span></span>\n<span class=\"line\"><span>    while not mon_sess.should_stop():</span></span>\n<span class=\"line\"><span>        # 执行同步训练</span></span>\n<span class=\"line\"><span>        mon_sess.run(train_op)</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3>PyTorch DDP</h3>\n<blockquote>\n<p>PyTorch Distributed: Experiences on Accelerating Data Parallel Training</p>\n</blockquote>\n<p><code>https://arxiv.org/abs/2006.15704</code> <code>https://github.com/pytorch/pytorch/</code></p>\n<h4>Python前端API</h4>\n<div class=\"language- line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"\" data-title=\"\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span> 1 import torch</span></span>\n<span class=\"line\"><span> 2 import torch.nn as nn</span></span>\n<span class=\"line\"><span> 3 import torch.nn.parallel as par</span></span>\n<span class=\"line\"><span> 4 import torch.optim as optim</span></span>\n<span class=\"line\"><span> 5</span></span>\n<span class=\"line\"><span> 6 # initialize torch.distributed properly</span></span>\n<span class=\"line\"><span> 7 # with init_process_group</span></span>\n<span class=\"line\"><span> 8</span></span>\n<span class=\"line\"><span> 9 # setup model and optimizer</span></span>\n<span class=\"line\"><span> 10 net = nn.Linear(10, 10)</span></span>\n<span class=\"line\"><span> 11 net = par.DistributedDataParallel(net)</span></span>\n<span class=\"line\"><span> 12 opt = optim.SGD(net.parameters(), lr=0.01)</span></span>\n<span class=\"line\"><span> 13</span></span>\n<span class=\"line\"><span> 14 # run forward pass</span></span>\n<span class=\"line\"><span> 15 inp = torch.randn(20, 10)</span></span>\n<span class=\"line\"><span> 16 exp = torch.randn(20, 10)</span></span>\n<span class=\"line\"><span> 17 out = net(inp)</span></span>\n<span class=\"line\"><span> 18</span></span>\n<span class=\"line\"><span> 19 # run backward pass</span></span>\n<span class=\"line\"><span> 20 nn.MSELoss()(out, exp).backward()</span></span>\n<span class=\"line\"><span> 21</span></span>\n<span class=\"line\"><span> 22 # update parameters</span></span>\n<span class=\"line\"><span> 23 opt.step()</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>PyTorch在设计API时做到了仅调用第11行代码中的DistributedDataParallel部分，就可以实现从本机训练到分布式训练的部署。</p>\n<h4>梯度同步算法</h4>\n<p>论文中所提到的DP背景本篇blog前文均有提及，不再赘述。</p>\n<h5>传统做法</h5>\n<ul>\n<li>batch较小时，通讯效率低</li>\n<li>计算与聚合之间存在间隔，很难做到即时通讯。</li>\n</ul>\n<h5>改进做法</h5>\n<p>PyTorch使用<code>Gradient Bucketing</code>，在小batch时，选择收集到一定量的梯度，再做聚合和同步。</p>\n<p>PyTorch使用<code>hook</code>机制，在反向传播计算完成后，调用自定义函数，当在同一个bucket中的梯度的hook都被调用后，就调用AllReduce对该bucket进行通信。</p>\n<p>这种方式有两个问题需要注意：</p>\n<p>（1）由于每个机器（进程）是独立计算的，因此不同机器之间处理的bucket的顺序将会不一致，这会导致梯度同步结果出现错误。因此，我们需要保证不同机器处理bucket的顺序一致。</p>\n<blockquote>\n<p>使用参数的反序作为梯度放入bucket的顺序。依据是，后向传播的顺序与梯度更新的顺序大致可认为是相同的。</p>\n</blockquote>\n<p>（2）不同迭代中，使用的参数可能不相同，使得某些参数的梯度不需要用到。</p>\n<blockquote>\n<p>前向传播结束后从输出开始遍历计算图，记录哪些参数参与计算，哪些参数没有参与计算，对于没有参与计算的参数，则直接标记为ready。</p>\n</blockquote>\n<h5>集合通讯库</h5>\n<p>PyTorch DDP支持三种通讯库：<code>NCCL</code>，<code>Gloo</code>和<code>MPI</code>。DDP支持用户使用统一的API ProcessGroup来调用不同的集合通讯库。</p>\n<ul>\n<li><code>NCCL doc</code>:<code>https://docs.nvidia.com/deeplearning/nccl/user-guide/docs/api.html</code></li>\n<li><code>Gloo doc</code>:<code>https://docs.solo.io/gateway/latest</code></li>\n<li><code>MPI doc</code>:<code>https://www.open-mpi.org/doc/</code></li>\n</ul>\n<h2>FSDP并行</h2>\n<h3>ZeRO</h3>\n<blockquote>\n<p>ZeRO: memory optimizations toward Training trillion parameter Models</p>\n</blockquote>\n<p><code>https://github.com/microsoft/DeepSpeed</code> <code>https://arxiv.org/abs/1910.02054</code></p>\n<h4>Abstract</h4>\n<p>深度学习模型在训练万亿级别参数时存在根本性限制，现有DP（数据并行）、MP（模型并行）方法无法满足日益增长的参数量需求，ZeRO（零冗余优化器）消除了数据和模型并行训练中的内存冗余，同时保持了低通信量和高计算粒度（计算与通信比率的定量或定性度量），使我们能够根据设备数量按比例扩展模型大小，同时保持高效率，实现超线性优化。</p>\n<h4>Extended Introduction</h4>\n<p>巨量参数可以大幅提升NLP处理能力，但参数量的上升在传统的单机GPU、TPU运算中无以为继，简单增加机器数量也用处不大。</p>\n<p>现有的PP（流水线并行）、MP都在通信和计算效率之间权衡，但重点是计算规模和速度。</p>\n<p>现有系统在模型训练中内存消耗的全部范围，并将其分为两部分:</p>\n<p>1）对于大型模型，【大部分内存】被模型状态占用，包括优化器状态、梯度和参数（不得不保存的模型内容）。</p>\n<p>2）剩余内存被激活、临时缓冲区和不可用的碎片内存所消耗，本文将其统称为残差状态（residual states）。</p>\n<h4>Where Did All the Memory Go</h4>\n<p>在模型计算的过程中，只有很少一部分被过程中产生的冗余量使用了（residual states），大部分内存都被用于模型本身数据的存储和运算（model states），ZeRO使用不同的方式优化这两种内存使用。</p>\n<h4>Model States: Optimizer States, Gradients and Parameters</h4>\n<p>论文以Adam优化器为例说明了模型造成的内存浪费是一件难以接受的事情，Adam本身对每一个参数都需要保留momentum和variance两个参数进行数据更新。</p>\n<p>看上去这是仅仅由1变2的内存保留变化，但是由于NVIDIA对于fp16精度计算的高优化度，要服务于计算速度内存变化就会发生膨胀。</p>\n<p>一般来说，在计算时，参数、输入、输出，均采用fp16半精度运算，但是考虑在更新权重的时候，可能在模型训练过程中梯度不大等原因，如果还是使用半精度进行运算，可能并不会产生权重累计，导致模型训练失效，所以此时应采用fp32的全精度计算，这又是一个仅在计算时才能用到的额外copy。</p>\n<blockquote>\n<p>FP32:1位符号位，8位指数位，23位尾数位<br>\nFP16:1位符号位，5位指数位，10位尾数位<br>\nBF16:1位符号位，8位指数位，7位尾数位</p>\n</blockquote>\n<p>假设有Ψ个参数，那就有4Ψ个byte（fp16）存储模型的参数和输入，同时又有12Ψ个byte（fp32）存储momentum和variance（Adam），也就是单计算仅需4Ψ，但是在更新参数进行新的计算时，需要额外的12Ψ，本文将其记作2Ψ+2Ψ+KΨ，其中K取决于模型。</p>\n<h4>Residual Memory Consumption</h4>\n<h5>Temporary buﬀers</h5>\n<p>是指通讯过程中、计算过程中产生的一些临时数据.</p>\n<h5>Memory Fragmentation</h5>\n<p>是指碎片化内存，用pytorch等使用虚拟内存分配方式的库时，可能内存池的维护并不能做到完全利用，论文假设有30%内存其实根本无法使用。</p>\n<h4>ZeRO: Insights and Overview</h4>\n<p>这一部分主要介绍作者使用ZeRO的一些想法。</p>\n<h5>Insights and Overview: ZeRO-DP</h5>\n<p>a）数据并行比模型并行更好，效率更高，因为通讯更少，计算粒度更精细</p>\n<p>b）数据并行内存使用并不高效，因为每一个分发计算都需要完全copy所有数据</p>\n<p>c）两种并行都需要存储模型状态变量，单就这一块部分内存而言，两者使用均不高效。</p>\n<p>我们可以考虑在某一个GPU中存储和更新参数，而在其他GPU需要使用其进行计算时，再进行通讯获取参数，从而降低内存占用。</p>\n<h4>Insights and Overview: ZeRO-R</h4>\n<h5>Reducing Activation Memory</h5>\n<p>a）MP占据模型内存，但是需要时常更新</p>\n<p>b）大模型即使的带宽小的情况下，也可以考虑每个GPU都各自保存和重算部分数据</p>\n<p>ZeRO考虑可以使用将模型内存切分成多分，分开重算，多次通讯的方式收集数据，减少内存使用。</p>\n<h5>Managing Temporary buﬀers</h5>\n<p>对于临时缓存采用开一段固定大小内存的方式进行反复存储。</p>\n<h5>Managing fragmented Memory.</h5>\n<p>内存碎片通过对不同寿命的内存进行整理，减少内存释放和分配的时间</p>\n<h4>Deep Dive into ZeRO-DP</h4>\n<h5>ZeRO1</h5>\n<p>对优化器本身存储的fp32数据进行切分，使每个GPU仅留1/N份数据。</p>\n<h5>ZeRO2</h5>\n<p>对数据并行中存储的fp16梯度进行切分，使每个GPU仅留1/N份数据。</p>\n<h5>ZeRO3</h5>\n<p>对数据并行中存储的fp16参数进行切分，使每个GPU仅留1/N份数据，使用时通讯获取完整参数。</p>\n<p>ZeRO1/2依托allreduce算法实现，NVIDIA本身支持这种优化并不会有通讯增加，但是ZeRO3需要对参数进行切分和更新，每次都会有Ψ 的额外通讯开销，但是事实上可以考虑在不同隐藏层中实现异步更新参数 ，使得参数额外开销尽可能减少。</p>\n<h4>Deep Dive into ZeRO-R</h4>\n<h5>Partitioned Activation Checkpointing</h5>\n<p>采用Megatron的模型并行方式，每个GPU保存1/N参数，对切分后部分输入分开运算，使用reduce-scatter更新各个参数状态，与ZeRO-DP的区别是，计算参数时，每个GPU都没有保存或通讯获取完整的参数，而是对输出进行通讯和更新。</p>\n<h5>Constant Size Buﬀers</h5>\n<p>使用固定大小buffer指定数据的单批发送量，保证带宽不浪费。</p>\n<h5>Memory Defragmentation</h5>\n<p>将数据池分为两部分，一部分存储大批量的计算数据，另一部分动态存储临时数据。</p>\n<h3>ZeRO-Offload</h3>\n<blockquote>\n<p>ZeRO-Offload：Democratizing Billion-Scale Model Training</p>\n</blockquote>\n<p><code>https://arxiv.org/pdf/2101.06840</code>  <code>https://arxiv.org/pdf/2101.06840</code></p>\n<h4>背景</h4>\n<p>GPU内存占用是一件非常昂贵的事情，在过去训练中人们往往忽略了CPU的计算潜力，高估了GPU的存储性能。</p>\n<p>ZeRO-Offload 优化：尽量减少数据在 GPU 与 CPU 之间的移动，并减少 CPU 计算时间，同时最大限度地节省 GPU 上的内存。</p>\n<h4>Efficiency</h4>\n<p>论文提出了一种名为Efficiency的offload策略，通过分析确定了CPU和GPU设备之间的最佳计算和数据划分策略，以在三个关键方面达到最优化：</p>\n<ul>\n<li>在CPU上的计算量比GPU少多个数量级，防止CPU性能瓶颈；</li>\n<li>最小化CPU和GPU之间的通信量，防止通信瓶颈；</li>\n<li>在实现最小通信量的同时，可证明地最大化节约GPU内存。</li>\n</ul>\n<p>offload 优化器计算要求CPU进行O(M)次计算，而GPU需进行O(MB)次计算，其中M和B分别为模型规模和 batch size 。在大多数情况下， batch size 较大，CPU计算量并不是瓶颈，但对于小 batch size，CPU计算量可能成为瓶颈。为了解决这个问题，采取了两种优化措施：</p>\n<ul>\n<li>高效的CPU优化器，其速度比现有技术快6倍；</li>\n<li>延迟一步的参数更新，允许将CPU优化器步骤与GPU计算重叠，同时确保准确性。这两种措施共同保证了ZeRO-Offload在小 batch size 下也能保持效率。</li>\n</ul>\n<h4>Unique Optimal Offload Strategy</h4>\n<p>为了确定最佳的下载策略，ZeRO-Offload将深度学习训练建模为数据流图，将该图分割为CPU和GPU设备之间的部分。</p>\n<p>训练的计算复杂度通常为O(MB)，其中M为模型大小，B为有效batch size。为避免CPU计算成为瓶颈，只有那些计算复杂度低于O(MB)的计算才能转移到CPU上</p>\n<p>FWD 和 BWD 的计算复杂度都是O(MB)，必须在GPU上进行，而其余的计算，如范数计算、权重更新等，其复杂度为O(M)，可以转移到CPU上</p>\n<p></p>\n<p>还需要最小化 CPU 与 GPU 的通信带宽，如图中所示，最小通信量为 BWD后 GPU 发送到 CPU 的 2M 梯度与 CPU 发送到 GPU 的 2M 参数，只有将 fp32 模型状态（momentum 32、variance 32和p32），Param Update 和 float2half 计算放置在一起，为一个 CPU 上的 Update Super Node，才能达成最小通信量策略</p>\n<h4>ZeRO-Offload Schedule</h4>\n<h5>单卡策略</h5>\n<p>ZeRO-Offload将数据进行分区，将fp16参数存储在GPU上，fp16梯度和所有优化器状态存储在CPU上。</p>\n<p>在训练过程中，首先通过 FWD 计算损失。由于fp16参数已经位于GPU上，因此这部分计算不需要与CPU进行通信。</p>\n<p>在 BWD 过程中，不同参数的梯度在后向调度的不同位置计算。ZeRO-Offload可以立即将这些梯度逐个或切分传输到 CPU 内存中。</p>\n<p>因此，在将梯度传输到CPU内存之前，只需要在GPU内存中临时保存少量的梯度。此外，每个梯度传输可以与反向计算重叠，消除大部分通信成本。</p>\n<p>在 BWD 之后，ZeRO-Offload在CPU上直接更新fp32参数和剩余的优化器状态，并将更新后的 fp32 参数从 CPU 内存复制到 GPU 内存中的fp16参数中。</p>\n<blockquote>\n<p>下图GPU与CPU二次通信应该是从CPU到GPU</p>\n</blockquote>\n<p></p>\n<div class=\"language- line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"\" data-title=\"\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span>for_parallel rank in range(world_size):</span></span>\n<span class=\"line\"><span>  # 初始化每个进程的层</span></span>\n<span class=\"line\"><span>  initialize_layers()</span></span>\n<span class=\"line\"><span>  for batch in dataset:</span></span>\n<span class=\"line\"><span>    # 前向传播</span></span>\n<span class=\"line\"><span>    x = forward(batch)</span></span>\n<span class=\"line\"><span>    # 计算损失并反向传播</span></span>\n<span class=\"line\"><span>    compute_loss(x, batch).backward()</span></span>\n<span class=\"line\"><span>    # 反向传播梯度</span></span>\n<span class=\"line\"><span>    backward(x.grad)</span></span>\n<span class=\"line\"><span>    # 更新参数</span></span>\n<span class=\"line\"><span>    step()</span></span>\n<span class=\"line\"><span></span></span>\n<span class=\"line\"><span>def _is_owner(i):</span></span>\n<span class=\"line\"><span>  # 判断当前进程是否拥有第 i 层</span></span>\n<span class=\"line\"><span>  return True if rank owns i else False</span></span>\n<span class=\"line\"><span></span></span>\n<span class=\"line\"><span>def initialize_layers():</span></span>\n<span class=\"line\"><span>  for i in range(num_layers):</span></span>\n<span class=\"line\"><span>    l = layers[i]</span></span>\n<span class=\"line\"><span>    # 在 GPU 上分配半精度参数</span></span>\n<span class=\"line\"><span>    allocate_on_gpu l.param_fp16</span></span>\n<span class=\"line\"><span>    if _is_owner(i):</span></span>\n<span class=\"line\"><span>      # 在 CPU 上分配全精度参数、优化器状态和梯度</span></span>\n<span class=\"line\"><span>      allocate_on_cpu l.param_fp32</span></span>\n<span class=\"line\"><span>      allocate_on_cpu l.optim_states_fp32</span></span>\n<span class=\"line\"><span>      allocate_on_cpu l.param_grad</span></span>\n<span class=\"line\"><span></span></span>\n<span class=\"line\"><span>def forward(x):</span></span>\n<span class=\"line\"><span>  # 前向传播逻辑</span></span>\n<span class=\"line\"><span>  for i in range(num_layers):</span></span>\n<span class=\"line\"><span>    x = layers[i].forward(x)</span></span>\n<span class=\"line\"><span>  return x</span></span>\n<span class=\"line\"><span></span></span>\n<span class=\"line\"><span>def backward(dx):</span></span>\n<span class=\"line\"><span>  # 反向传播逻辑</span></span>\n<span class=\"line\"><span>  for i in range(num_layers, 0, -1):</span></span>\n<span class=\"line\"><span>    dx = layers[i].backward(dx)</span></span>\n<span class=\"line\"><span>    # 将梯度减少到拥有该层的进程</span></span>\n<span class=\"line\"><span>    reduce(layers[i].grad, dest_rank = _owner_rank(i))</span></span>\n<span class=\"line\"><span>    if _is_owner(i):</span></span>\n<span class=\"line\"><span>      # 将梯度复制到 CPU</span></span>\n<span class=\"line\"><span>      l.cpu_grad.copy(l.grad)</span></span>\n<span class=\"line\"><span>    else:</span></span>\n<span class=\"line\"><span>      pass</span></span>\n<span class=\"line\"><span>    # 删除 GPU 上的梯度</span></span>\n<span class=\"line\"><span>    del layers[i].grad</span></span>\n<span class=\"line\"><span></span></span>\n<span class=\"line\"><span>def step():</span></span>\n<span class=\"line\"><span>  # 参数更新逻辑</span></span>\n<span class=\"line\"><span>  for i in range(num_layers):</span></span>\n<span class=\"line\"><span>    l = layers[i]</span></span>\n<span class=\"line\"><span>    if _is_owner(i):</span></span>\n<span class=\"line\"><span>      # 在 CPU 上更新参数</span></span>\n<span class=\"line\"><span>      update_in_cpu(l.optim_states_fp32,</span></span>\n<span class=\"line\"><span>                    l.cpu_grad,</span></span>\n<span class=\"line\"><span>                    l.param_fp32)</span></span>\n<span class=\"line\"><span>      # 将更新后的参数复制回 GPU</span></span>\n<span class=\"line\"><span>      l.param_fp16.copy(l.param_fp32)</span></span>\n<span class=\"line\"><span>    # 广播更新后的参数</span></span>\n<span class=\"line\"><span>    BROADCAST(l.param_fp16, src = _owner_rank(i))</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h5>多卡策略</h5>\n<p>ZeRO-Offload 将梯度和优化器状态在不同的 GPU 之间进行 partition，并且每个 GPU 将自己的 part offload 到 CPU 内存中，存储持续整个训练过程</p>\n<p>BWD 过程中，在 GPU 上 reduce-scatter 计算梯度并平均，每个 GPU 仅将属于其 part 的平均梯度 offload 到 CPU 内存中</p>\n<p>一旦梯度在 CPU 上可用，优化器状态 part 对应的每个 DP 进程直接在 CPU 上并行更新对应的参数 part</p>\n<p>更新完成后，参数 part 发送到 GPU，在 GPU 上对参数进行类似 ZeRO-2 的 all-gather 操作</p>\n<p></p>\n<h2>流水线并行</h2>\n<h3>GPipe</h3>\n<blockquote>\n<p>GPipe: Efficient Training of Giant Neural Networks using Pipeline Parallelism</p>\n</blockquote>\n<p><code>https://arxiv.org/abs/1811.06965</code></p>\n<h4>Gpipe Abstract</h4>\n<p>增大模型规模可以提升模型效果，但是单卡/单机GPU内存有限，必须引入分布式系统</p>\n<p>GPipe使用模型并行（MP）方案，将模型切分成一连串stage，每个stage放在独立的设备（GPU/TPU）上，实现对超大规模模型的支持</p>\n<p>利用Pipeline（PP）的方案，提高了模型并行模式下的设备利用率</p>\n<p>最终GPipe通过更大规模的模型和更大的batch_size，在图像和NLP的模型上都得到更好的模型效果。</p>\n<h4>Design</h4>\n<h5>Naive Model Parallelism</h5>\n<p>论文中提到的MP就是传统的MP方案，不是Magatron-LM提出的新MP方案（事实上是TP），对数据按层切分，而非对所有输入、输出、参数都按块切分。</p>\n<p></p>\n<p>模型有 12 层（layer），可以切为 4 份（4个cell），每份 3 层。然后每份放到一块 GPU 上</p>\n<p>第 k 个 cell 的模型参数，就放在第 k 块 GPU 上。</p>\n<p>Fk和 Bk 分别表示第 k 个 cell 的 forward 和 backward 计算</p>\n<p></p>\n<p>单批量以这种顺序进行计算，Fk和 Bk 分别表示第 k 个批次的forward和backward运算（注意与上张图不同），每一种颜色代表一块 GPU，每一列代表一个时间段</p>\n<p>问题是：每块 GPU 都会有大量的空闲时间</p>\n<h5>Pipeline Parallelism 1 - Split into micro-batches</h5>\n<p>单batch（mini-batch）切成更小的micro-batch，然后流水线并行（类似CPU指令执行）</p>\n<p></p>\n<blockquote>\n<p>为什么不流水线并行batch，而是切分后再流水线并行？\n多batch可以提速，但占用空间会多很多<br>\n多batch训练时，可能会导致梯度更新不稳定，结果收敛不明显</p>\n</blockquote>\n<h5>Pipeline Parallelism 2 - re-materialization</h5>\n<p>GPU 只保留最开始的输入，中间结果全部丢掉；计算梯度时，再重新计算这些中间结果。</p>\n<p>减少计算时内存占用，但要增加计算时长。</p>\n<h2>张量并行（TP）</h2>\n<h3>Megatron-LM</h3>\n<blockquote>\n<p>Megatron-LM: Training Multi-Billion Parameter Language Models Using Model Parallelism</p>\n</blockquote>\n<p><code>https://arxiv.org/abs/1909.08053</code> <code>https://github.com/NVIDIA/Megatron-LM</code></p>\n<h4>Model Parallel Transformers</h4>\n<ul>\n<li>在MLP中最常用的操作是MM + GELU，即输入与参数矩阵相乘 和 激活函数</li>\n<li>一种方法是沿着其行(row)将weight矩阵A分割，并沿着其列(columns)输入X分割，来实现tensor-model-parallel，从下图中我们可以看出，在该方法下，需要通过同步来保障语义对等。</li>\n</ul>\n<p></p>\n<ul>\n<li>另一种方法是沿着它的列(columns)分割A，这种方法的好处是保障了各自在独立计算时的语义对等，不需要进行额外通讯</li>\n</ul>\n<p></p>\n<p>不过由于我们使用的A是同一个，在反向传播时要保证在保存不同切分W的GPU中均及时更新A，在PyTorch中可以通过下面的代码简单实现：</p>\n<div class=\"language- line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"\" data-title=\"\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span>class f(torch.autograd.Function):</span></span>\n<span class=\"line\"><span> def forward(ctx, x):</span></span>\n<span class=\"line\"><span>  return x</span></span>\n<span class=\"line\"><span> def backward(ctx, gradient):</span></span>\n<span class=\"line\"><span>  all_reduce(gradient)</span></span>\n<span class=\"line\"><span>  return gradient</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><ul>\n<li>通过结合上述两种方法，可以在transformer中实现简单并发，针对MLP、SA两个环节做了如下优化，实现MLP的整体的tensor-model-parallel且语义和原始MLP对等：</li>\n</ul>\n<p></p>\n<ul>\n<li>在优化 embedding 层时，PyTorch 将 embedding 操作视为对输入进行索引操作，即在权重矩阵上执行 index_select 操作。实际上，这个操作等价于先对输入进行 one-hot 编码，然后与权重矩阵进行矩阵乘法（mm）操作。可以将 embedding 层视为线性层来处理，并使用模型并行操作来优化。</li>\n</ul>\n<div class=\"language- line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"\" data-title=\"\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span>class VocabParallelEmbedding():</span></span>\n<span class=\"line\"><span>    def __init__(self, num_embeddings, embedding_dim, init_method=init.xavier_normal_):</span></span>\n<span class=\"line\"><span>        super(VocabParallelEmbedding, self).__init__()</span></span>\n<span class=\"line\"><span>        ...</span></span>\n<span class=\"line\"><span>        # 通过获取当前 tensor_model_parallel 的 rank 来确定当前卡要 embedding 的 category id，初始化权重</span></span>\n<span class=\"line\"><span>        self.vocab_start_index, self.vocab_end_index = VocabUtility.vocab_range_from_global_vocab_size(</span></span>\n<span class=\"line\"><span>            self.num_embeddings, get_tensor_model_parallel_rank(),</span></span>\n<span class=\"line\"><span>            self.tensor_model_parallel_size)</span></span>\n<span class=\"line\"><span>        self.num_embeddings_per_partition = self.vocab_end_index - self.vocab_start_index</span></span>\n<span class=\"line\"><span>        self.weight = Parameter(torch.empty(</span></span>\n<span class=\"line\"><span>            self.num_embeddings_per_partition, self.embedding_dim,</span></span>\n<span class=\"line\"><span>            dtype=args.params_dtype))</span></span>\n<span class=\"line\"><span>        ...</span></span>\n<span class=\"line\"><span></span></span>\n<span class=\"line\"><span>    def forward(self, input_):</span></span>\n<span class=\"line\"><span>        if self.tensor_model_parallel_size &gt; 1:</span></span>\n<span class=\"line\"><span>            # 把当前卡上不要的 category idx mask 掉</span></span>\n<span class=\"line\"><span>            input_mask = (input_ &lt; self.vocab_start_index) | \\</span></span>\n<span class=\"line\"><span>                         (input_ &gt;= self.vocab_end_index)</span></span>\n<span class=\"line\"><span>            # Mask 掉的输入</span></span>\n<span class=\"line\"><span>            masked_input = input_.clone() - self.vocab_start_index</span></span>\n<span class=\"line\"><span>            masked_input[input_mask] = 0</span></span>\n<span class=\"line\"><span>        else:</span></span>\n<span class=\"line\"><span>            masked_input = input_</span></span>\n<span class=\"line\"><span>        # 获取嵌入向量</span></span>\n<span class=\"line\"><span>        output_parallel = F.embedding(masked_input, self.weight,</span></span>\n<span class=\"line\"><span>                                      self.padding_idx, self.max_norm,</span></span>\n<span class=\"line\"><span>                                      self.norm_type, self.scale_grad_by_freq,</span></span>\n<span class=\"line\"><span>                                      self.sparse)</span></span>\n<span class=\"line\"><span>        # 把 mask 掉的 category idx 对应的嵌入向量处理成 0</span></span>\n<span class=\"line\"><span>        if self.tensor_model_parallel_size &gt; 1:</span></span>\n<span class=\"line\"><span>            output_parallel[input_mask, :] = 0.0</span></span>\n<span class=\"line\"><span>        # 在所有模型并行 GPU 上进行 reduce 操作</span></span>\n<span class=\"line\"><span>        output = reduce_from_tensor_model_parallel_region(output_parallel)</span></span>\n<span class=\"line\"><span>        return output</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2>3D并行</h2>\n<blockquote>\n<p>Efficient Large-Scale Language Model Training on GPU Clusters Using Megatron-LM</p>\n</blockquote>\n<p><code>https://arxiv.org/pdf/2104.04473</code> <code>https://github.com/NVIDIA/Megatron-LM</code></p>\n<h3>贡献</h3>\n<p>如何合理的使用上面的多种并行技术一直是一个困难的命题，本文中研究人员提出了一种名为PTD-P的策略，在一个大规模的GPU集群上达到超过50%的效能。</p>\n<p>本文探讨了以下几种因素对效率的影响：</p>\n<ul>\n<li>不同的并行策略：通常张量并行只适用于一个multi-GPU服务器内部，而流水线并行则几乎只用于更大的模型（多机集群）</li>\n<li>流水线并行中的schedule：对通信、pipeline bubble的大小、内存都有重要的影响</li>\n<li>参数的选取（如microbatch的大小）：对于内存使用和kernel计算效率、pipeline bubble大小也有影响</li>\n</ul>\n<h3>数据并行</h3>\n<p>问题：</p>\n<ul>\n<li>batch过小，会导致单块GPU利用率降低，而通信成本大大增长</li>\n<li>理论上GPU数量等于batch size，这也限制了可以使用的卡的规模</li>\n</ul>\n<h3>考虑流水线并行</h3>\n<p>流水线并行技术将一个模型（Transformer）中的不同层发放到多块GPU上，将原本一个batch的数据分解为多个更小的micro batch，通过编排forward pass和backward pass可以来获取不同的性能。<br>\n为了确保optimizer semantics（也就是端到端的计算能够正确的完成），不同GPU之间需要进行定期同步</p>\n",
      "date_published": "2024-10-28T00:00:00.000Z",
      "date_modified": "2025-01-23T13:43:11.000Z",
      "authors": [],
      "tags": [
        "SOSD"
      ]
    },
    {
      "title": "CS149 Lab Assignment1",
      "url": "https://newzone.top/posts/CS149_asst1.html",
      "id": "https://newzone.top/posts/CS149_asst1.html",
      "summary": "Prog1_mandelbort_threads 环境配置 本人使用OS为Ubuntu 22.04, 还是建议使用Linux系统做Lab, 很多环境配置会方便一些. CS149_Asst1并不需要额外配置运行环境, 下载解压一下编译环境就好啦! 下载包: 解压包: 配置环境路径: 环境配置完成后就可以clone repo到本地来开始lab了: 任务分析...",
      "content_html": "<h2>Prog1_mandelbort_threads</h2>\n<h3>环境配置</h3>\n<p>本人使用OS为<code>Ubuntu 22.04</code>, 还是建议使用Linux系统做Lab, 很多环境配置会方便一些.</p>\n<p>CS149_Asst1并不需要额外配置运行环境, 下载解压一下编译环境就好啦!<br>\n下载包:</p>\n<div class=\"language- line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"\" data-title=\"\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span>    wget https://github.com/ispc/ispc/releases/download/v1.21.0/ispc-v1.21.0-linux.tar.gz</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div></div></div><p>解压包:</p>\n<div class=\"language- line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"\" data-title=\"\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span>    tar -xvf ispc-v1.21.0-linux.tar.gz</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div></div></div><p>配置环境路径:</p>\n<div class=\"language- line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"\" data-title=\"\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span>    export PATH=$PATH:${HOME}/Downloads/ispc-v1.21.0-linux/bin</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div></div></div><p>环境配置完成后就可以clone repo到本地来开始lab了:</p>\n<div class=\"language- line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"\" data-title=\"\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span>    git clone https://github.com/stanford-cs149/asst1.git</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div></div></div><h3>任务分析</h3>\n<blockquote>\n<p>Pro1的内容主要是为了让学生了解<code>std::thread</code>的并行机制和\"多线程不一定高效率\"的并发事实, 所以难度并不算大~~(这是我的事后诸葛亮)~~, 整体框架已经在源码中基本完成了.完成后可以通过<code>make</code> + <code>./mandelbort --&lt;args&gt;</code>检验正确与否.</p>\n</blockquote>\n<p>task :</p>\n<ul>\n<li>创建<code>线程0</code>和<code>线程1</code>, 分别计算图像的上下两个部分, 即<code>将图像的不同空间交给不同线程</code>计算, 这被称为<code>空间分解(spatial decomposition)</code>.</li>\n<li>扩展代码使其能够使用<code>2, 3, 4, 5, 6, 7, 8</code>个线程, 进行空间分解, 生成加速图, 假设加速是否与线程数线性相关并加以验证.</li>\n<li>在<code>workerThreadStart()</code>的开头和结尾插入计时代码, 验证并解释task2中提出的猜想.</li>\n<li>修改一开始的线程分配方式, 实现将两个图片都拉到<code>8线程时7-8倍加速比</code>的效果, 找到适应任何线程数的泛型分配方式(不需要线程之间进行响应和同步), 报告最后得出的8线程加速比.</li>\n<li>使用<code>16个线程</code>运行改进后代码, 回答性能是否明显高于8线程并解释原因.</li>\n</ul>\n<p>事实上task中给的提示还是比较明显的, 在<code>task1</code>中解释了空间分解的概念, 那么通过对图片本身的<code>上下多份分割</code>,就可以解决这个问题,要注意分割的时候会不会漏行.</p>\n<h3>任务实现</h3>\n<p>我们将一开始就对任务给出多线程的解决方式, 并在后续针对数据结果决定是否要进行优化.</p>\n<p>首先我们可以根据阅读<code>mandelbrotSerial.cpp</code>中的源码, 得到mandelbrotSerial()函数事实上是用来计算<code>Mandelbrot</code>图像的, 可以简单分析一下<code>mandelbrotSerial()</code>函数的各个参数:</p>\n<div class=\"language- line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"\" data-title=\"\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span>    void mandelbrotSerial(</span></span>\n<span class=\"line\"><span>    float x0, float y0, float x1, float y1, // 复平面左上和右下两个点坐标</span></span>\n<span class=\"line\"><span>    int width, int height,                  // 图像宽度和高度</span></span>\n<span class=\"line\"><span>    int startRow, int numRows,              // 开始行和总计算行数</span></span>\n<span class=\"line\"><span>    int maxIterations,                      // 最大迭代次数</span></span>\n<span class=\"line\"><span>    int output[]);                          // 每个点的迭代次数</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>不难发现只要我们给出<code>startRow</code>, <code>numRows</code>, 其余保持图像默认参数, 就可以完成计算了.<br>\n所以可以给出函数<code>workerThreadStart(WorkerArgs * const args)</code>的代码:</p>\n<div class=\"language- line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"\" data-title=\"\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span>    size_t rows = args -&gt; height / args -&gt; numThreads;          // 确定要计算的行数</span></span>\n<span class=\"line\"><span>    if (args -&gt; height % args -&gt; numThreads) {                  // 如果该遇到整除要加一行避免遗漏</span></span>\n<span class=\"line\"><span>        rows++;</span></span>\n<span class=\"line\"><span>    }</span></span>\n<span class=\"line\"><span>    size_t startRow = args -&gt; threadId * rows;                  // 确定开始行</span></span>\n<span class=\"line\"><span>    // 如果已经到最后部分不够切分, 直接处理最后部分</span></span>\n<span class=\"line\"><span>    rows = rows &gt; args -&gt; height - startRow ? args -&gt; height - startRow : rows;</span></span>\n<span class=\"line\"><span>    // 调用mandelbrotSerial</span></span>\n<span class=\"line\"><span>    mandelbrotSerial(args -&gt; x0, args -&gt; y0, args -&gt; x1, args -&gt; y1, args -&gt; width, </span></span>\n<span class=\"line\"><span>                    args -&gt; height, startRow, rows, args -&gt; maxIterations, args -&gt; output);</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div>",
      "date_published": "2024-09-18T00:00:00.000Z",
      "date_modified": "2024-09-18T15:50:38.000Z",
      "authors": [],
      "tags": [
        "CS149_Lab"
      ]
    },
    {
      "title": "CS61A",
      "url": "https://newzone.top/posts/CS61A.html",
      "id": "https://newzone.top/posts/CS61A.html",
      "summary": "week1 Lecture Welcome The first lecture just a simple explaination of CS61A and explnation of the Expression Tree which is composed of a operator and several operands, so I just...",
      "content_html": "<h2>week1</h2>\n<h3>Lecture</h3>\n<h4>Welcome</h4>\n<p>The first lecture just a simple explaination of CS61A and explnation of the <code>Expression Tree</code> which is composed of a operator and several operands, so I just paste the picture of the Tree.<br>\n</p>\n<blockquote>\n<p>Easy but interesting.<br>\nIf you learned data structure, you may think this is <code>n-ary tree</code>.</p>\n</blockquote>\n<h4>Functions</h4>\n<h5>name</h5>\n<h6>built-in</h6>\n<p>Like c/c++, python also has its own way to name or rename a parameter, a function or a variable and so on. The lecture will introduce it at beginning.</p>\n<p><code>Ctrl + L</code> is used to flash the terminal in python session.</p>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt;&gt;&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">pi</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">  </span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">Traceback</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (most </span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">recent</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> call</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> last</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">):  </span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">  File</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> \"&lt;stdin&gt;\",</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> line</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> 1,</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> in</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#ABB2BF\"> &lt;</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">modul</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">e</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#ABB2BF\">&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">  </span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">NameError:</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> name</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> 'pi'</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> is</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> not</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> defined</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>oops! No pi! This means the parameter is not a built-in parameter. We have to <code>import</code> it.</p>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt;&gt;&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">from</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> math</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> import</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> pi</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">  </span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt;&gt;&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">pi</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">  </span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">3.141592653589793</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>The same goes for imported functions.</p>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt;&gt;&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">from</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> math</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> import</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> sin</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">  </span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt;&gt;&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">sin(pi</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)  </span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">1.2246467991473532e-16</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">  </span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt;&gt;&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">sin(pi/2</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)  </span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">1.0</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><blockquote>\n<p>You may find it not zero after sin(pi), because of the type of data storage in the computer or just a data cut. Not important.</p>\n</blockquote>\n<h6>name by ourselves</h6>\n<p>We can also name our own parameter:</p>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt;&gt;&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">radius</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> =</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 10</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt;&gt;&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">radius</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">10</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>Even multiple variables named simultaneously is also supported:</p>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt;&gt;&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">area,</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> circ</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> =</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> pi</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#E5C07B\"> *</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> radius</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#E5C07B\"> *</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">radius,</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 2</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#E5C07B\"> *</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> pi</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#E5C07B\"> *</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> radius</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt;&gt;&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">area</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">314.1592653589793</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt;&gt;&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">circ</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">62.83185307179586</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>The same goes for imported functions.</p>\n<h6>define</h6>\n<p>We can edit our functions by <code>def</code>:</p>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt;&gt;&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">def</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> square</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">x</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">...</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">     return</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> mul</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">x,</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> x</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">...</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> </span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt;&gt;&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">square(11</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">121</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>If we change the value of parameter, the value of expression named by us will not change, but if define a functions will solve the issue:</p>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt;&gt;&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">def</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> area</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">()</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">:</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">...</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">     return</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> pi</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#E5C07B\"> *</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> radius</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#E5C07B\"> *</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> radius</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">...</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> </span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt;&gt;&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">area</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">()</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">314.1592653589793</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt;&gt;&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">radius</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> =</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 20</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt;&gt;&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">area</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">()</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">1256.6370614359173</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><blockquote>\n<p>A function differs from a name in that its return expression here gets re-evaluated every time it's called.</p>\n</blockquote>\n<h4>defining functions</h4>\n<p>structure of defining:</p>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt;&gt;&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">def</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#ABB2BF\"> &lt;</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">nam</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">e</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">&gt;(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#ABB2BF\">&lt;</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">formal parameters</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#ABB2BF\">&gt;</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    return</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#ABB2BF\"> &lt;</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">return</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> expressio</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">n</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#ABB2BF\">&gt;</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><blockquote>\n<p>Fuctions will be evaluated when it is called.</p>\n</blockquote>\n<p>The lecture also introduce the difference between local frames and global frames. I passed it for my c&amp;c++ basics.</p>\n<h4>Environment Diagrams</h4>\n<p></p>\n<p>Online Python Tutor:</p>\n<blockquote>\n<p>https://pythontutor.com/visualize.html#</p>\n</blockquote>\n<h4>Print and None</h4>\n<p>Just talk about the difference of print and evaluate and <code>Nonetype</code>.</p>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt;&gt;&gt; </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">None</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt;&gt;&gt; </span><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">print</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">None</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">None</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p></p>\n<h3>Lab</h3>\n<h4>Lab0:Getting Started</h4>\n<blockquote>\n<p>Download starter files from: <code>https://cs61a.org/lab/lab00/lab00.zip</code></p>\n</blockquote>\n<h5>Introduction</h5>\n<p>This lab explains how to setup your computer to complete assignments and introduces some of the basics of Python.</p>\n<p>Components cheek passed, so skip them.</p>\n<h5>Setup</h5>\n<p>skip.</p>\n<h5>First Assignment</h5>\n<h6>What Would Python Do?</h6>\n<p>Enter the following in your terminal to begin this section:</p>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"># we don't have edu email of berkeley, so we need to add --local</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">python</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> ok</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> -u</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> --local</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>Esay to pass:</p>\n<div class=\"language-bash line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"bash\" data-title=\"bash\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">=====================================================================</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">Assignment:</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> Lab</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">OK,</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> version</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> v1.18.1</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">=====================================================================</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#ABB2BF\">~</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">Unlocking</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> tests</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">At</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> each</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> \"? \",</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> type</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> what</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> you</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> would</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> expect</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> the</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> output</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> to</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> be.</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">Type</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> exit</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">() </span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">to</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> quit</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div>",
      "date_published": "2025-01-01T10:28:19.000Z",
      "date_modified": "2025-01-01T10:28:19.000Z",
      "authors": [],
      "tags": [
        "CS61A"
      ]
    },
    {
      "title": "MLSys_分布式开发（选读）",
      "url": "https://newzone.top/posts/MLSys_%E5%88%86%E5%B8%83%E5%BC%8F%EF%BC%88%E9%80%89%E8%AF%BB).html",
      "id": "https://newzone.top/posts/MLSys_%E5%88%86%E5%B8%83%E5%BC%8F%EF%BC%88%E9%80%89%E8%AF%BB).html",
      "summary": "序列并行 Megatron Reducing Activation Recomputation in Large Transformer Models https://arxiv.org/pdf/2205.05198 Abstract 在大模型训练过程中显存占用过大往往成为瓶颈，一般会通过重计算的方式降低显存占用，但会带来额外的计算代价。本文提出seq...",
      "content_html": "<h2>序列并行</h2>\n<h3>Megatron</h3>\n<p>Reducing Activation Recomputation in Large Transformer Models</p>\n<p><code>https://arxiv.org/pdf/2205.05198</code></p>\n<h4>Abstract</h4>\n<p>在大模型训练过程中显存占用过大往往成为瓶颈，一般会通过<code>重计算</code>的方式降低显存占用，但会带来额外的计算代价。本文提出<code>sequece parallel(序列并行,简称SP)</code>和<code>selective activation recomputation</code>两种方法，可以结合TP有效减少不必要的计算量。</p>\n<p>下图中绿色部分表示不同参数级别模型中需要用于保存activation需要的显存大小，蓝色部分表示不同参数级别模型中需要用于保存<code>parameter</code>和<code>optimizer state</code>需要的显存大小。红色线表示baseline(A100的显存)80G。</p>\n<p>通过对比可以发现,原本单A100跑不了的模型,经过SP优化后可以在单A100上运行了,这就给我们加大数据量和多机并行提供了极大的便利</p>\n<p></p>\n<h4>Activation Memory</h4>\n<p>本文以Transformer结构为例估算<code>Activation Memory</code>，Activation指FWD和BWD梯度计算中创建的所有<code>tensor</code>。不包含模型参数大小和优化器中状态大小，但是包含dropout用到的<code>mask tensor</code>。</p>\n<p></p>\n<p>本文推导与假设中用到了以下几个参量:<br>\n</p>\n<p>本文假设h极大(实际上一般也确实极大), 认为2sb远小于sbh, 即只考虑中间过程的Memory(shb), 忽略输入输出的Memory</p>\n<p>对于Attention模块,这一部分依赖于softmax实现:</p>\n<p v-pre=\"\" class=\"katex-block\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>A</mi><mi>t</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo stretchy=\"false\">(</mo><mi>Q</mi><mo separator=\"true\">,</mo><mi>K</mi><mo separator=\"true\">,</mo><mi>V</mi><mo stretchy=\"false\">)</mo><mo>=</mo><mi>s</mi><mi>o</mi><mi>f</mi><mi>t</mi><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy=\"false\">(</mo><mfrac><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt></mfrac><mo stretchy=\"false\">)</mo><mi>V</mi></mrow><annotation encoding=\"application/x-tex\">\nAttention(Q,K,V)=softmax(\\frac{QK^T}{\\sqrt{d_k}})V \n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\">tt</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\">Q</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.4483em;vertical-align:-0.93em;\"></span><span class=\"mord mathnormal\">so</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">ma</span><span class=\"mord mathnormal\">x</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.5183em;\"><span style=\"top:-2.2528em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord sqrt\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8572em;\"><span class=\"svg-align\" style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\" style=\"padding-left:0.833em;\"><span class=\"mord\"><span class=\"mord mathnormal\">d</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-2.8172em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"hide-tail\" style=\"min-width:0.853em;height:1.08em;\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"400em\" height=\"1.08em\" viewBox=\"0 0 400000 1080\" preserveAspectRatio=\"xMinYMin slice\"><path d=\"M95,702\nc-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14\nc0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54\nc44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10\ns173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429\nc69,-144,104.5,-217.7,106.5,-221\nl0 -0\nc5.3,-9.3,12,-14,20,-14\nH400000v40H845.2724\ns-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7\nc-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z\nM834 80h400000v40h-400000z\"></path></svg></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1828em;\"><span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">Q</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8413em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">T</span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.93em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose\">)</span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span></span></span></span></span></p>\n<p>具体实现图例见下:</p>\n<p></p>\n<p>对于<code>Attention</code>块来说，输入的元素个数为<code>sbh</code>个，每个元素以<code>半精度</code>(2 bytes)来进行存储的话，对应输入的元素大小为<code>2sbh bytes</code></p>\n<p><code>Attention</code>块中包含一个<code>self-attention</code>、一个<code>linear(线性映射层)</code>和<code>attention dropout</code>层。对于<code>linear</code>需要保存输入的<code>Activation</code>大小为<code>2sbh</code>, 对于<code>attention dropout</code>层需要<code>mask</code>的大小为<code>sbh</code>(对于一个元素的mask只用1个bytes)，对于<code>self-attention</code>块的<code>Activation Memory</code>的计算有以下几块：</p>\n<ul>\n<li>Query(Q),Key(K),Value(V) <code>matrix mul</code>：input共享，元素个数为sbh个，总大小是 <code>2sbh bytes</code>。</li>\n<li><span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><annotation encoding=\"application/x-tex\">QK^{T}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0358em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">Q</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8413em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">T</span></span></span></span></span></span></span></span></span></span></span></span>矩阵相乘：需要分别创建保存<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Q</mi></mrow><annotation encoding=\"application/x-tex\">Q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8778em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">Q</span></span></span></span>和<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>K</mi></mrow><annotation encoding=\"application/x-tex\">K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span></span></span></span>的矩阵，每个矩阵元素总大小为<code>2sbh bytes</code>, 总共大小为<code>4sbh bytes</code></li>\n</ul>\n<p>原始Self-Attention例子(此处X切分仅作示意,实际上是按行切分的):</p>\n<p></p>\n<p></p>\n<ul>\n<li>\n<p>dropout的mask层矩阵的大小与softmax的输出一样，元素个数都是<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>a</mi><msup><mi>s</mi><mn>2</mn></msup><mi>b</mi></mrow><annotation encoding=\"application/x-tex\">as^{2}b</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span><span class=\"mord mathnormal\">b</span></span></span></span>个，但mask单个元素的大小只用<code>1 bytes</code>即可，总的大小为 <span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>a</mi><msup><mi>s</mi><mn>2</mn></msup><mi>b</mi></mrow><annotation encoding=\"application/x-tex\">as^{2}b</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span><span class=\"mord mathnormal\">b</span></span></span></span> bytes</p>\n</li>\n<li>\n<p>softmax的输出也会用于反向的计算，需要缓存下来，对应大小 <span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>a</mi><msup><mi>s</mi><mn>2</mn></msup><mi>b</mi></mrow><annotation encoding=\"application/x-tex\">as^{2}b</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span><span class=\"mord mathnormal\">b</span></span></span></span> bytes</p>\n</li>\n<li>\n<p><span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>V</mi></mrow><annotation encoding=\"application/x-tex\">V</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span></span></span></span>矩阵的大小之前没有统计，和<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Q</mi></mrow><annotation encoding=\"application/x-tex\">Q</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8778em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">Q</span></span></span></span>、<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>K</mi></mrow><annotation encoding=\"application/x-tex\">K</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span></span></span></span>矩阵一样，大小也是<code>2sbh bytes</code></p>\n</li>\n</ul>\n<blockquote>\n<p>Attention 模块总的大小为 11sbh + 5<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>a</mi><msup><mi>s</mi><mn>2</mn></msup><mi>b</mi></mrow><annotation encoding=\"application/x-tex\">as^{2}b</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8141em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span><span class=\"mord mathnormal\">b</span></span></span></span> bytes。</p>\n</blockquote>\n<p><code>MLP的Activation大小计算</code>：MLP中有两层线性layer，分别存储输入矩阵大小为<code>2sbh bytes</code>和<code>8sbh bytes</code>；GeLU的反向也需要对输入进行缓存，大小为<code>8sbh bytes</code>; dropout层需要<code>sbh bytes</code>; 总大小为<code>19sbh</code>。</p>\n<p><code>LayerNorm的Activation大小计算</code>：每个LayerNorm层的输入需要<code>2sbh</code>大小，有两个LayerNorm层，总大小为<code>4sbh bytes</code>.</p>\n<p>一层transformer的memory总的大小为:</p>\n<p v-pre=\"\" class=\"katex-block\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>A</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>M</mi><mi>e</mi><mi>m</mi><mi>o</mi><mi>r</mi><mi>y</mi><mi>P</mi><mi>e</mi><mi>r</mi><mi>L</mi><mi>a</mi><mi>y</mi><mi>e</mi><mi>r</mi><mo>=</mo><mi>s</mi><mi>b</mi><mi>h</mi><mrow><mo fence=\"true\">(</mo><mn>34</mn><mo>+</mo><mn>5</mn><mfrac><mrow><mi>a</mi><mi>s</mi></mrow><mi>h</mi></mfrac><mo fence=\"true\">)</mo></mrow></mrow><annotation encoding=\"application/x-tex\">\nActivationMemoryPerLayer=sbh\\left(34+5\\frac{as}h\\right) \n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8778em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">ory</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">er</span><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">yer</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.836em;vertical-align:-0.686em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">bh</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size2\">(</span></span><span class=\"mord\">34</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord\">5</span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.1076em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">h</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size2\">)</span></span></span></span></span></span></span></p>\n<h4>Tensor Parallel</h4>\n<p>在TP并行中只在Attention和MLP两个地方进行了并行计算，对于两块的输入并没有并行操作。</p>\n<p>图中<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>f</mi></mrow><annotation encoding=\"application/x-tex\">f</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span></span></span></span>和<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><mi>f</mi><mo stretchy=\"true\">‾</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\overline{f}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0889em;vertical-align:-0.1944em;\"></span><span class=\"mord overline\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8944em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span></span></span><span style=\"top:-3.8144em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"overline-line\" style=\"border-bottom-width:0.04em;\"></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1944em;\"><span></span></span></span></span></span></span></span></span>互为共轭(conjugate)，<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>f</mi></mrow><annotation encoding=\"application/x-tex\">f</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span></span></span></span>在前向时不做操作，反向时执行all-reduce;<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><mi>f</mi><mo stretchy=\"true\">‾</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\overline{f}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0889em;vertical-align:-0.1944em;\"></span><span class=\"mord overline\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8944em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span></span></span><span style=\"top:-3.8144em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"overline-line\" style=\"border-bottom-width:0.04em;\"></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1944em;\"><span></span></span></span></span></span></span></span></span>在前向时执行all-reduce, 反向时不做操作。</p>\n<p></p>\n<p>考虑TP并行(并行度为<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi></mrow><annotation encoding=\"application/x-tex\">t</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6151em;\"></span><span class=\"mord mathnormal\">t</span></span></span></span>)，并行部分有MLP的Linear部分(18sbh bytes)和Attention的QKV部分(6sbh bytes)， <code>ActivationMemoryPerLayer</code>的值降为：</p>\n<p v-pre=\"\" class=\"katex-block\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>A</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>M</mi><mi>e</mi><mi>m</mi><mi>o</mi><mi>r</mi><mi>y</mi><mi>P</mi><mi>e</mi><mi>r</mi><mi>L</mi><mi>a</mi><mi>y</mi><mi>e</mi><mi>r</mi><mo>=</mo><mi>s</mi><mi>b</mi><mi>h</mi><mrow><mo fence=\"true\">(</mo><mn>10</mn><mo>+</mo><mfrac><mn>24</mn><mi>t</mi></mfrac><mo>+</mo><mn>5</mn><mfrac><mrow><mi>a</mi><mi>s</mi></mrow><mrow><mi>h</mi><mi>t</mi></mrow></mfrac><mo fence=\"true\">)</mo></mrow></mrow><annotation encoding=\"application/x-tex\">\nActivationMemoryPerLayer=sbh\\left(10+\\frac{24}t+5\\frac{as}{ht}\\right)\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8778em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">ory</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">er</span><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">yer</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.4em;vertical-align:-0.95em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">bh</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">(</span></span><span class=\"mord\">10</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.3214em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">24</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord\">5</span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.1076em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">t</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">)</span></span></span></span></span></span></span></p>\n<h4>Sequence Parallel</h4>\n<p>在Tensor模型并行基础上提出了<code>Sequence Parallel</code>，对于非TP并行的部分在sequence维度都是相互独立的，所以可以在sequence维度上进行拆分(即sequence parallel)。</p>\n<p>拆分后如下图，<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>f</mi></mrow><annotation encoding=\"application/x-tex\">f</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span></span></span></span>和<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><mi>f</mi><mo stretchy=\"true\">‾</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\overline{f}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0889em;vertical-align:-0.1944em;\"></span><span class=\"mord overline\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8944em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span></span></span><span style=\"top:-3.8144em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"overline-line\" style=\"border-bottom-width:0.04em;\"></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1944em;\"><span></span></span></span></span></span></span></span></span>替换为<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>g</mi></mrow><annotation encoding=\"application/x-tex\">g</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.625em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span></span></span></span>和<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mover accent=\"true\"><mi>g</mi><mo stretchy=\"true\">‾</mo></mover></mrow><annotation encoding=\"application/x-tex\">\\overline{g}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.825em;vertical-align:-0.1944em;\"></span><span class=\"mord overline\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6306em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span></span></span><span style=\"top:-3.5506em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"overline-line\" style=\"border-bottom-width:0.04em;\"></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1944em;\"><span></span></span></span></span></span></span></span></span>​在前向是reduce-scatter, 反向是all-gather通信。</p>\n<p></p>\n<p>以MLP为例，详细说明拆分步骤:</p>\n<p>MLP层由两个Linear层组成，对应的计算公式如下, 其中<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>X</mi></mrow><annotation encoding=\"application/x-tex\">X</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span></span></span></span>的大小为<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>s</mi><mo>×</mo><mi>b</mi><mo>×</mo><mi>h</mi></mrow><annotation encoding=\"application/x-tex\">s × b × h</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6667em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.7778em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\">b</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\">h</span></span></span></span>;<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>A</mi></mrow><annotation encoding=\"application/x-tex\">A</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">A</span></span></span></span>和<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>B</mi></mrow><annotation encoding=\"application/x-tex\">B</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span></span></span>是Linear的权重weight矩阵，大小为<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>h</mi><mo>×</mo><mn>4</mn><mi>h</mi></mrow><annotation encoding=\"application/x-tex\">h × 4h</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7778em;vertical-align:-0.0833em;\"></span><span class=\"mord mathnormal\">h</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord\">4</span><span class=\"mord mathnormal\">h</span></span></span></span>和<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>4</mn><mi>h</mi><mo>×</mo><mi>h</mi></mrow><annotation encoding=\"application/x-tex\">4h×h</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.7778em;vertical-align:-0.0833em;\"></span><span class=\"mord\">4</span><span class=\"mord mathnormal\">h</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">×</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\">h</span></span></span></span></p>\n<p>论文做如下符号说明:</p>\n<p v-pre=\"\" class=\"katex-block\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable rowspacing=\"0.25em\" columnalign=\"right left\" columnspacing=\"0em\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mi>Y</mi></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><mo>=</mo><mtext>LayerNorm</mtext><mo stretchy=\"false\">(</mo><mi>X</mi><mo stretchy=\"false\">)</mo><mo separator=\"true\">,</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mi>Z</mi></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><mo>=</mo><mtext>GeLU</mtext><mo stretchy=\"false\">(</mo><mi>Y</mi><mi>A</mi><mo stretchy=\"false\">)</mo><mo separator=\"true\">,</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mi>W</mi></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><mo>=</mo><mi>Z</mi><mi>B</mi><mo separator=\"true\">,</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mi>V</mi></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><mo>=</mo><mtext>Dropout</mtext><mo stretchy=\"false\">(</mo><mi>W</mi><mo stretchy=\"false\">)</mo><mo separator=\"true\">,</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\n\\begin{aligned}Y&amp;=\\text{LayerNorm}(X),\\\\Z&amp;=\\text{GeLU}(YA),\\\\W&amp;=ZB,\\\\V&amp;=\\text{Dropout}(W),\\end{aligned}\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:6em;vertical-align:-2.75em;\"></span><span class=\"mord\"><span class=\"mtable\"><span class=\"col-align-r\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:3.25em;\"><span style=\"top:-5.41em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span></span></span><span style=\"top:-3.91em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">Z</span></span></span><span style=\"top:-2.41em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span></span></span><span style=\"top:-0.91em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.75em;\"><span></span></span></span></span></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:3.25em;\"><span style=\"top:-5.41em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord text\"><span class=\"mord\">LayerNorm</span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span><span class=\"mclose\">)</span><span class=\"mpunct\">,</span></span></span><span style=\"top:-3.91em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord text\"><span class=\"mord\">GeLU</span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span><span class=\"mord mathnormal\">A</span><span class=\"mclose\">)</span><span class=\"mpunct\">,</span></span></span><span style=\"top:-2.41em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">ZB</span><span class=\"mpunct\">,</span></span></span><span style=\"top:-0.91em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord text\"><span class=\"mord\">Dropout</span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"mclose\">)</span><span class=\"mpunct\">,</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.75em;\"><span></span></span></span></span></span></span></span></span></span></span></span></p>\n<p></p>\n<ul>\n<li>对<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>X</mi></mrow><annotation encoding=\"application/x-tex\">X</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span></span></span></span>按sequence维度切分， <span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>X</mi><mo>=</mo><mrow><mo fence=\"true\">[</mo><msubsup><mi>X</mi><mn>1</mn><mi>s</mi></msubsup><mo separator=\"true\">,</mo><msubsup><mi>X</mi><mn>2</mn><mi>s</mi></msubsup><mo fence=\"true\">]</mo></mrow></mrow><annotation encoding=\"application/x-tex\">X = \\left[ X^s_1, X^s_2 \\right]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\">[</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6644em;\"><span style=\"top:-2.4519em;margin-left:-0.0785em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">s</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2481em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6644em;\"><span style=\"top:-2.4519em;margin-left:-0.0785em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">s</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2481em;\"><span></span></span></span></span></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\">]</span></span></span></span></span>，LayerNorm的结果<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Y</mi><mo>=</mo><mrow><mo fence=\"true\">[</mo><msubsup><mi>Y</mi><mn>1</mn><mi>s</mi></msubsup><mo separator=\"true\">,</mo><msubsup><mi>Y</mi><mn>2</mn><mi>s</mi></msubsup><mo fence=\"true\">]</mo></mrow></mrow><annotation encoding=\"application/x-tex\">Y = \\left[ Y^s_1, Y^s_2 \\right]</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\">[</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6644em;\"><span style=\"top:-2.4519em;margin-left:-0.2222em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">s</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2481em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6644em;\"><span style=\"top:-2.4519em;margin-left:-0.2222em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">s</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2481em;\"><span></span></span></span></span></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\">]</span></span></span></span></span>；</li>\n<li>考虑GeLU非线性，进行all-gather，计算<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Z</mi><mo>=</mo><mi>G</mi><mi>e</mi><mi>L</mi><mi>U</mi><mo stretchy=\"false\">(</mo><mi>Y</mi><mi>A</mi><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">Z = GeLU(YA)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">Z</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">G</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">LU</span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span><span class=\"mord mathnormal\">A</span><span class=\"mclose\">)</span></span></span></span>；</li>\n<li>对<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>A</mi></mrow><annotation encoding=\"application/x-tex\">A</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\">A</span></span></span></span>进行列切分的tensor并行，得到结果<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Y</mi><msubsup><mi>A</mi><mn>1</mn><mi>c</mi></msubsup></mrow><annotation encoding=\"application/x-tex\">YA^c_1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9314em;vertical-align:-0.2481em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6644em;\"><span style=\"top:-2.4519em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2481em;\"><span></span></span></span></span></span></span></span></span></span>​和<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>Y</mi><msubsup><mi>A</mi><mn>2</mn><mi>c</mi></msubsup></mrow><annotation encoding=\"application/x-tex\">YA^c_2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.9314em;vertical-align:-0.2481em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6644em;\"><span style=\"top:-2.4519em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2481em;\"><span></span></span></span></span></span></span></span></span></span></li>\n<li>对<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>B</mi></mrow><annotation encoding=\"application/x-tex\">B</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span></span></span></span>进行行切分的tensor并行，得到结果<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mi>Z</mi><mn>1</mn><mi>h</mi></msubsup><msubsup><mi>B</mi><mn>1</mn><mi>r</mi></msubsup></mrow><annotation encoding=\"application/x-tex\">Z^h_1 B^r_1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0972em;vertical-align:-0.2481em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">Z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8491em;\"><span style=\"top:-2.4519em;margin-left:-0.0715em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2481em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6644em;\"><span style=\"top:-2.4519em;margin-left:-0.0502em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2481em;\"><span></span></span></span></span></span></span></span></span></span>和<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msubsup><mi>Z</mi><mn>2</mn><mi>h</mi></msubsup><msubsup><mi>B</mi><mn>2</mn><mi>r</mi></msubsup></mrow><annotation encoding=\"application/x-tex\">Z^h_2 B^r_2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0972em;vertical-align:-0.2481em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">Z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8491em;\"><span style=\"top:-2.4519em;margin-left:-0.0715em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2481em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.6644em;\"><span style=\"top:-2.4519em;margin-left:-0.0502em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2481em;\"><span></span></span></span></span></span></span></span></span></span></li>\n<li>得到<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>W</mi><mn>1</mn></msub></mrow><annotation encoding=\"application/x-tex\">W_1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>和<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mi>W</mi><mn>2</mn></msub></mrow><annotation encoding=\"application/x-tex\">W_2</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span></span>后进行reduce-scatter</li>\n</ul>\n<p>具体过程见下:</p>\n<p v-pre=\"\" class=\"katex-block\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable rowspacing=\"0.25em\" columnalign=\"right left\" columnspacing=\"0em\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mo stretchy=\"false\">[</mo><msubsup><mi>Y</mi><mn>1</mn><mi>s</mi></msubsup><mo separator=\"true\">,</mo><msubsup><mi>Y</mi><mn>2</mn><mi>s</mi></msubsup><mo stretchy=\"false\">]</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><mtable rowspacing=\"0.25em\" columnalign=\"right left\" columnspacing=\"0em\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><mo>=</mo><mtext>LayerNorm</mtext><mo stretchy=\"false\">(</mo><mo stretchy=\"false\">[</mo><msubsup><mi>X</mi><mn>1</mn><mi>s</mi></msubsup><mo separator=\"true\">,</mo><msubsup><mi>X</mi><mn>2</mn><mi>s</mi></msubsup><mo stretchy=\"false\">]</mo><mo stretchy=\"false\">)</mo><mo separator=\"true\">,</mo></mrow></mstyle></mtd></mtr></mtable></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mtext>Y</mtext></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><mo>=</mo><mi>g</mi><mo stretchy=\"false\">(</mo><msubsup><mi>Y</mi><mn>1</mn><mi>s</mi></msubsup><mo separator=\"true\">,</mo><msubsup><mi>Y</mi><mn>2</mn><mi>s</mi></msubsup><mo stretchy=\"false\">)</mo><mo separator=\"true\">,</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mtable rowspacing=\"0.25em\" columnalign=\"right\" columnspacing=\"\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mo stretchy=\"false\">[</mo><msubsup><mi>Z</mi><mn>1</mn><mi>h</mi></msubsup><mo separator=\"true\">,</mo><msubsup><mi>Z</mi><mn>2</mn><mi>h</mi></msubsup><mo stretchy=\"false\">]</mo></mrow></mstyle></mtd></mtr></mtable></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><mo>=</mo><mo stretchy=\"false\">[</mo><mtext>GeLU</mtext><mo stretchy=\"false\">(</mo><mi>Y</mi><msubsup><mi>A</mi><mn>1</mn><mi>c</mi></msubsup><mo stretchy=\"false\">)</mo><mo separator=\"true\">,</mo><mtext>&nbsp;GeLU</mtext><mo stretchy=\"false\">(</mo><mi>Y</mi><msubsup><mi>A</mi><mn>2</mn><mi>c</mi></msubsup><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">]</mo><mo separator=\"true\">,</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><msub><mi>W</mi><mn>1</mn></msub></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><mo>=</mo><msubsup><mi>Z</mi><mn>1</mn><mi>h</mi></msubsup><msubsup><mi>B</mi><mn>1</mn><mi>r</mi></msubsup><mtext>&nbsp;and&nbsp;</mtext><msub><mi>W</mi><mn>2</mn></msub><mo>=</mo><msubsup><mi>Z</mi><mn>2</mn><mi>h</mi></msubsup><msubsup><mi>B</mi><mn>2</mn><mi>r</mi></msubsup><mo separator=\"true\">,</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mtable rowspacing=\"0.25em\" columnalign=\"right\" columnspacing=\"\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mo stretchy=\"false\">[</mo><msubsup><mi>W</mi><mn>1</mn><mi>s</mi></msubsup><mo separator=\"true\">,</mo><msubsup><mi>W</mi><mn>2</mn><mi>s</mi></msubsup><mo stretchy=\"false\">]</mo></mrow></mstyle></mtd></mtr></mtable></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><mo>=</mo><mover accent=\"true\"><mi>g</mi><mo>ˉ</mo></mover><mo stretchy=\"false\">(</mo><msub><mi>W</mi><mn>1</mn></msub><mo separator=\"true\">,</mo><msub><mi>W</mi><mn>2</mn></msub><mo stretchy=\"false\">)</mo><mo separator=\"true\">,</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mtable rowspacing=\"0.25em\" columnalign=\"right\" columnspacing=\"\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mo stretchy=\"false\">[</mo><msubsup><mi>V</mi><mn>1</mn><mi>s</mi></msubsup><mo separator=\"true\">,</mo><msubsup><mi>V</mi><mn>2</mn><mi>s</mi></msubsup><mo stretchy=\"false\">]</mo></mrow></mstyle></mtd></mtr></mtable></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><mo>=</mo><mo stretchy=\"false\">[</mo><mrow><mi mathvariant=\"normal\">D</mi><mi mathvariant=\"normal\">r</mi><mi mathvariant=\"normal\">o</mi><mi mathvariant=\"normal\">p</mi><mi mathvariant=\"normal\">o</mi><mi mathvariant=\"normal\">u</mi><mi mathvariant=\"normal\">t</mi></mrow><mo stretchy=\"false\">(</mo><msubsup><mi>W</mi><mn>1</mn><mi>s</mi></msubsup><mo stretchy=\"false\">)</mo><mo separator=\"true\">,</mo><mtext>&nbsp;Dropout</mtext><mo stretchy=\"false\">(</mo><msubsup><mi>W</mi><mn>2</mn><mi>s</mi></msubsup><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">]</mo><mi mathvariant=\"normal\">.</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\n\\begin{aligned}\n[Y_1^s,Y_2^s]&amp; \\begin{aligned}&amp;=\\text{LayerNorm}([X_1^s,X_2^s]),\\end{aligned} \\\\\n\\text{Y}&amp; =g(Y_1^s,Y_2^s), \\\\\n\\begin{aligned}[Z_1^h,Z_2^h]\\end{aligned}&amp; =[\\text{GeLU}(YA_1^c),\\text{ GeLU}(YA_2^c)], \\\\\nW_{1}&amp; =Z_1^hB_1^r\\text{ and }W_2=Z_2^hB_2^r, \\\\\n\\begin{aligned}[W_1^s,W_2^s]\\end{aligned}&amp; =\\bar{g}(W_1,W_2), \\\\\n\\begin{aligned}[V_1^s,V_2^s]\\end{aligned}&amp; =[\\mathrm{Dropout}(W_1^s),\\text{ Dropout}(W_2^s)]. \n\\end{aligned}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:10.3182em;vertical-align:-4.9091em;\"></span><span class=\"mord\"><span class=\"mtable\"><span class=\"col-align-r\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:5.4091em;\"><span style=\"top:-7.4387em;\"><span class=\"pstrut\" style=\"height:3.0296em;\"></span><span class=\"mord\"><span class=\"mopen\">[</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7144em;\"><span style=\"top:-2.453em;margin-left:-0.2222em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">s</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7144em;\"><span style=\"top:-2.453em;margin-left:-0.2222em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">s</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mclose\">]</span></span></span><span style=\"top:-5.7987em;\"><span class=\"pstrut\" style=\"height:3.0296em;\"></span><span class=\"mord\"><span class=\"mord text\"><span class=\"mord\">Y</span></span></span></span><span style=\"top:-4.1091em;\"><span class=\"pstrut\" style=\"height:3.0296em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mtable\"><span class=\"col-align-r\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.0296em;\"><span style=\"top:-3.1304em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mopen\">[</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">Z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8991em;\"><span style=\"top:-2.453em;margin-left:-0.0715em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">Z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8991em;\"><span style=\"top:-2.453em;margin-left:-0.0715em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mclose\">]</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.5296em;\"><span></span></span></span></span></span></span></span></span></span><span style=\"top:-2.3804em;\"><span class=\"pstrut\" style=\"height:3.0296em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span></span></span><span style=\"top:-0.7204em;\"><span class=\"pstrut\" style=\"height:3.0296em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mtable\"><span class=\"col-align-r\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1em;\"><span style=\"top:-3.16em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mopen\">[</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7144em;\"><span style=\"top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">s</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7144em;\"><span style=\"top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">s</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mclose\">]</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.5em;\"><span></span></span></span></span></span></span></span></span></span><span style=\"top:1.0796em;\"><span class=\"pstrut\" style=\"height:3.0296em;\"></span><span class=\"mord\"><span class=\"mord\"><span class=\"mtable\"><span class=\"col-align-r\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1em;\"><span style=\"top:-3.16em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mopen\">[</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7144em;\"><span style=\"top:-2.453em;margin-left:-0.2222em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">s</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7144em;\"><span style=\"top:-2.453em;margin-left:-0.2222em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">s</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mclose\">]</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.5em;\"><span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:4.9091em;\"><span></span></span></span></span></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:5.4091em;\"><span style=\"top:-7.4387em;\"><span class=\"pstrut\" style=\"height:3.0296em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mord\"><span class=\"mtable\"><span class=\"col-align-r\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:2.84em;\"></span><span class=\"mord\"></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.5em;\"><span></span></span></span></span></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1em;\"><span style=\"top:-3.16em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord text\"><span class=\"mord\">LayerNorm</span></span><span class=\"mopen\">([</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7144em;\"><span style=\"top:-2.453em;margin-left:-0.0785em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">s</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">X</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7144em;\"><span style=\"top:-2.453em;margin-left:-0.0785em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">s</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mclose\">])</span><span class=\"mpunct\">,</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.5em;\"><span></span></span></span></span></span></span></span></span></span><span style=\"top:-5.7987em;\"><span class=\"pstrut\" style=\"height:3.0296em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7144em;\"><span style=\"top:-2.453em;margin-left:-0.2222em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">s</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7144em;\"><span style=\"top:-2.453em;margin-left:-0.2222em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">s</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mpunct\">,</span></span></span><span style=\"top:-4.1091em;\"><span class=\"pstrut\" style=\"height:3.0296em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mopen\">[</span><span class=\"mord text\"><span class=\"mord\">GeLU</span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7144em;\"><span style=\"top:-2.453em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord text\"><span class=\"mord\">&nbsp;GeLU</span></span><span class=\"mopen\">(</span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">Y</span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7144em;\"><span style=\"top:-2.453em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">c</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)]</span><span class=\"mpunct\">,</span></span></span><span style=\"top:-2.3804em;\"><span class=\"pstrut\" style=\"height:3.0296em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">Z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8991em;\"><span style=\"top:-2.453em;margin-left:-0.0715em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7144em;\"><span style=\"top:-2.453em;margin-left:-0.0502em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mord text\"><span class=\"mord\">&nbsp;and&nbsp;</span></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">Z</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8991em;\"><span style=\"top:-2.453em;margin-left:-0.0715em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">h</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.05017em;\">B</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7144em;\"><span style=\"top:-2.453em;margin-left:-0.0502em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span></span></span><span style=\"top:-0.7204em;\"><span class=\"pstrut\" style=\"height:3.0296em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord accent\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.5678em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span></span><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"accent-body\" style=\"left:-0.2222em;\"><span class=\"mord\">ˉ</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1944em;\"><span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mpunct\">,</span></span></span><span style=\"top:1.0796em;\"><span class=\"pstrut\" style=\"height:3.0296em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mopen\">[</span><span class=\"mord\"><span class=\"mord mathrm\">Dropout</span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7144em;\"><span style=\"top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">1</span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">s</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord text\"><span class=\"mord\">&nbsp;Dropout</span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.7144em;\"><span style=\"top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\">2</span></span></span><span style=\"top:-3.113em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">s</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.247em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)]</span><span class=\"mord\">.</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:4.9091em;\"><span></span></span></span></span></span></span></span></span></span></span></span></p>\n<p>TP在一次前向和后向总共有4次的<code>all-reduce</code>操作，在SP一次前向和后向总共有4次<code>all-gather</code>和4次<code>reduce-scatter</code>操作。<br>\n<code>ring all-reduce</code> 执行过程中有两步，先是一个<code>reduce-scatter</code>然后一个<code>all-gather</code>，SP没有引入更多的通信代价。</p>\n<p v-pre=\"\" class=\"katex-block\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mtable rowspacing=\"0.25em\" columnalign=\"right left\" columnspacing=\"0em\"><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mi>A</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>v</mi><mi>a</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>M</mi><mi>e</mi><mi>m</mi><mi>o</mi><mi>r</mi><mi>y</mi><mi>P</mi><mi>e</mi><mi>r</mi><mi>L</mi><mi>a</mi><mi>y</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><mo>=</mo><mi>s</mi><mi>b</mi><mi>h</mi><mrow><mo fence=\"true\">(</mo><mfrac><mn>10</mn><mi>t</mi></mfrac><mo>+</mo><mfrac><mn>24</mn><mi>t</mi></mfrac><mo>+</mo><mn>5</mn><mfrac><mrow><mi>a</mi><mi>s</mi></mrow><mrow><mi>h</mi><mi>t</mi></mrow></mfrac><mo fence=\"true\">)</mo></mrow></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel=\"0\" displaystyle=\"true\"><mrow><mrow></mrow><mo>=</mo><mfrac><mrow><mi>s</mi><mi>b</mi><mi>h</mi></mrow><mi>t</mi></mfrac><mrow><mo fence=\"true\">(</mo><mn>34</mn><mo>+</mo><mn>5</mn><mfrac><mrow><mi>a</mi><mi>s</mi></mrow><mi>h</mi></mfrac><mo fence=\"true\">)</mo></mrow></mrow></mstyle></mtd></mtr></mtable><annotation encoding=\"application/x-tex\">\n\\begin{aligned}\nActivationMemoryPerLayer&amp; =sbh\\left(\\frac{10}t+\\frac{24}t+5\\frac{as}{ht}\\right) \\\\\n&amp;=\\frac{sbh}t\\left(34+5\\frac{as}h\\right)\n\\end{aligned}</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:5.0575em;vertical-align:-2.2787em;\"></span><span class=\"mord\"><span class=\"mtable\"><span class=\"col-align-r\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.7787em;\"><span style=\"top:-4.7787em;\"><span class=\"pstrut\" style=\"height:3.45em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">ory</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">P</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">er</span><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">yer</span></span></span><span style=\"top:-2.1573em;\"><span class=\"pstrut\" style=\"height:3.45em;\"></span><span class=\"mord\"></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.2787em;\"><span></span></span></span></span></span><span class=\"col-align-l\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.7787em;\"><span style=\"top:-4.7787em;\"><span class=\"pstrut\" style=\"height:3.45em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">bh</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">(</span></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.3214em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">10</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.3214em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">24</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord\">5</span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.1076em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">t</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size3\">)</span></span></span></span></span><span style=\"top:-2.1573em;\"><span class=\"pstrut\" style=\"height:3.45em;\"></span><span class=\"mord\"><span class=\"mord\"></span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.3714em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">t</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">bh</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size2\">(</span></span><span class=\"mord\">34</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mord\">5</span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.1076em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">h</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size2\">)</span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:2.2787em;\"><span></span></span></span></span></span></span></span></span></span></span></span></p>\n<h3>DeepSpeed-Ulysses</h3>\n<p><code>DeepSpeed Ulysses: System Optimizations for Enabling Training of Extreme Long Sequence Transformer Models</code><br>\n<code>https://arxiv.org/pdf/2309.14509</code></p>\n<blockquote>\n<p>DeepSpeed在知乎也有官号, 这里仅作简述, 官号本身讲的也非常不错, 链接在这儿:https://zhuanlan.zhihu.com/p/652206513</p>\n</blockquote>\n<h4>简介</h4>\n<ul>\n<li>长序列在LLM应用中非常重要, 长上下文的保存有助于LLM推理, 需求大token和长Sequence的输入</li>\n<li>现有的DP TP PP不能解决序列维度的扩展问题</li>\n<li>现有的序列并行方法依托内存通讯, 不够高效</li>\n</ul>\n<p>DeepSpeed-Ulysses将各个样本在<code>序列维度</code>上分割给参与的GPU。在attention计算之前，它对已分割的查询(Q)、键(K)和值(V)执行<code>all-to-all</code>通信操作，以使每个GPU接收完整的序列，但仅用于注意力头的<code>非重叠子集</code>。<br>\n这使得参与的GPU可以并行计算不同的注意力头。最后，DeepSpeed-Ulysses还使用另一个<code>all-to-all</code>来在注意力头上收集结果，同时重新在序列维度上进行分区。</p>\n<h4>DeepSpeed-Ulysses的核心设计</h4>\n<p></p>\n<p></p>\n<p>与已知的Transformer架构一样，设计由<code>N个输入序列</code>在<code>P个可用设备</code>上分区组成。每个本地N/P分区都被投影到查询（Q）、键（K）和值（V）嵌入中。接下来，(QKV) 嵌入通过参与计算设备之间的高度优化的全对全集合（all-to-all collectives）进行全局的 QKV 收集。在全对全集合后，每个头的注意力计算形式为：</p>\n<p v-pre=\"\" class=\"katex-block\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>O</mi><mi>u</mi><mi>t</mi><mi>p</mi><mi>u</mi><mi>t</mi><mtext>&nbsp;</mtext><mi>c</mi><mi>o</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>x</mi><mi>t</mi><mo>=</mo><mi>S</mi><mi>o</mi><mi>f</mi><mi>t</mi><mi>m</mi><mi>a</mi><mi>x</mi><mtext>&nbsp;</mtext><mo stretchy=\"false\">(</mo><mfrac><mrow><mi>Q</mi><msup><mi>K</mi><mi>T</mi></msup></mrow><msqrt><mi>d</mi></msqrt></mfrac><mo stretchy=\"false\">)</mo><mi>V</mi></mrow><annotation encoding=\"application/x-tex\">\nOutput~context=Softmax~(\\frac{QK^T}{\\sqrt{d}})V\n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8778em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">tp</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">t</span><span class=\"mspace nobreak\">&nbsp;</span><span class=\"mord mathnormal\">co</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">x</span><span class=\"mord mathnormal\">t</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.4483em;vertical-align:-0.93em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">ma</span><span class=\"mord mathnormal\">x</span><span class=\"mspace nobreak\">&nbsp;</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.5183em;\"><span style=\"top:-2.1778em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord sqrt\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9322em;\"><span class=\"svg-align\" style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\" style=\"padding-left:0.833em;\"><span class=\"mord mathnormal\">d</span></span></span><span style=\"top:-2.8922em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"hide-tail\" style=\"min-width:0.853em;height:1.08em;\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"400em\" height=\"1.08em\" viewBox=\"0 0 400000 1080\" preserveAspectRatio=\"xMinYMin slice\"><path d=\"M95,702\nc-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14\nc0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54\nc44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10\ns173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429\nc69,-144,104.5,-217.7,106.5,-221\nl0 -0\nc5.3,-9.3,12,-14,20,-14\nH400000v40H845.2724\ns-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7\nc-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z\nM834 80h400000v40h-400000z\"></path></svg></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1078em;\"><span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">Q</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8413em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">T</span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.93em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose\">)</span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span></span></span></span></span></p>\n<p>注意力计算后，另一个全对全集合将注意力计算的输出上下文张量转换为序列(N/P)并行，用于Transformer模型层的剩余模块中的后续操作。</p>\n<h3>Sequence Parallelism</h3>\n<p><code>Sequence Parallelism: Long Sequence Training from System Perspective</code><br>\n<code>https://arxiv.org/pdf/2105.13120</code></p>\n<h4>论文背景</h4>\n<p>和Ulysses一样, 这个SP也是目的也是解决输入序列规模问题, 而不是像Megtron-LM一样解决计算过程中的内存占用问题.</p>\n<p>文章将自己的SP流程和PP TP模型做了比较:<br>\n</p>\n<h4>主要工作</h4>\n<p>本文认为SP最主要的问题是跨设备如何计算<code>sub-sequences</code>的<code>attention scores</code>问题，为了解决该问题，本文设计出<code>Ring Self-Attention</code>来解决此问题.</p>\n<blockquote>\n<p>感觉想法来源于Ring-AllReduce, 而且只优化了自注意力部分</p>\n</blockquote>\n<p></p>\n<blockquote>\n<p>RSA感觉就是将输入序列进行切分, 通过将序列整体切分成小的chunk, 使得每一个chunk都尽可能大, 用commnication换取序列长度</p>\n</blockquote>\n<p></p>\n<h3>Ring-Attention</h3>\n<p><code>Ring Attention with Blockwise Transformers for Near-Infinite Context</code><br>\n<code>https://arxiv.org/pdf/2310.01889</code></p>\n<h4>背景</h4>\n<p>老生常谈的transformer长序列要求，不做赘述。</p>\n<h4>Ring Attention</h4>\n<p>本文提出以<code>分块方式</code>执行Self-Attention和FWD计算，多机分布序列维度，从而实现并发计算和通信.<br>\n由于该方法将环中主机设备之间的<code>Key Value Block</code>通信与compute重叠，因此将其命名：<code>环注意(Ring Attention)</code></p>\n<p>具体实现：</p>\n<p></p>\n<p>该方法在主机设备之间构建Self-Attention的外循环，每个主机设备具有一个<code>query block</code>，并通过<code>Key Value Block</code>遍历主机<code>Ring</code>，以<code>逐块</code>的方式进行注意力和前馈网络计算。<br>\n当计算Self-Attention时，每个主机将<code>Key Value Block</code>发送到下一个主机，同时从前一个主机接收<code>Key Value Block</code>。</p>\n<p></p>\n<p>对于内循环，每个设备计算其各自的Self-Attention和FWD。在内循环期间，每个设备将用于compute的<code>Key Value Block</code>的副本发送到Ring中的下一个设备，同时从前一个设备接收<code>Key Value Block</code>。<br>\n由于<code>块计算比块传输需要更长的时间</code>，与标准Transformer相比，此过程不会增加开销。</p>\n<blockquote>\n<p>这种Ring Attention方式可以突破序列长度限制（对于单卡内存需求来说，而非模型整体来说），因为我们在Attention之前矩阵乘就已经切分了Squence，让每一个卡分批成环去跑一小批token</p>\n<p>这种方式理论上并不影响训练结果，因为最小训练单位还是一个token（对Squence做切分时的原则）</p>\n<p>天才般的想法！（我觉得）好吧也需要堆卡出奇迹</p>\n</blockquote>\n<blockquote>\n<p>那么代价呢？\n文章的训练测试规模比较小，能否在大规模训练时取得想象中的线性效果，还是未知数\n文章只对Attention和FWD操作做了优化，基础操作还有进一步优化的空间，可以考虑采用4D并行。</p>\n</blockquote>\n<h3>DISTFLASHATTN</h3>\n<p><code>https://arxiv.org/pdf/2310.03294</code></p>\n<h4>背景</h4>\n<p>部分SP方法，如Ring Attention缺少高效的Attention实现。（前文提及的<code>基础操作还有进一步优化的空间</code>）</p>\n<h4>论文方法</h4>\n<p>文章针对三个challenge提出了三个解决方法，解决了高校Attention实现、分布式应用等问题。</p>\n<h5>token-level workload imbalance</h5>\n<p>这主要是由于causal mask引起的attention计算问题，如果简单分块计算约会有1/2的计算资源浪费。<br>\n因为一般causal mask就是会用矩阵以对角线为界mask数据, 按照ring拓扑结构进行计算也会有约一半的CPU处于等待状态。</p>\n<p>针对这个问题，论文中提出<code>Token-level workload balancing</code>的调度算法，通过给空闲的worker来fetch部分key-value数据，计算后再传递回去。</p>\n<p></p>\n<h5>Prohibitive communication overhead</h5>\n<p>需要通信汇总不同worker上的attention结果，本文提出通过计算<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>a</mi><mi>t</mi><mi>t</mi><mi>n</mi><mo stretchy=\"false\">(</mo><msub><mi>q</mi><mi>p</mi></msub><mo separator=\"true\">,</mo><msub><mi>k</mi><mi>r</mi></msub><mo separator=\"true\">,</mo><msub><mi>v</mi><mi>r</mi></msub><mo separator=\"true\">,</mo><msub><mi>s</mi><mi>p</mi></msub><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">attn(q_p,k_r,v_r,s_p)</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0361em;vertical-align:-0.2861em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">tt</span><span class=\"mord mathnormal\">n</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">p</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">s</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.1514em;\"><span style=\"top:-2.55em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">p</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2861em;\"><span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span> prefetch张量来完成通信<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>w</mi><mi>o</mi><mi>r</mi><mi>k</mi><mi>e</mi><mi>r</mi><mspace width=\"1em\"></mspace><mi>p</mi><mi><mover><mo><mi mathvariant=\"normal\">⟵</mi><mo>⁡</mo></mo><mrow><msub><mi>k</mi><mrow><mi>r</mi><mo>+</mo><mn>1</mn></mrow></msub><mo separator=\"true\">,</mo><msub><mi>v</mi><mrow><mi>r</mi><mo>+</mo><mn>1</mn></mrow></msub></mrow></mover></mi><mi>w</mi><mi>o</mi><mi>r</mi><mi>k</mi><mi>e</mi><mi>r</mi><mspace width=\"1em\"></mspace><mi>r</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">worker\\quad p\\overset{k_{r+1},v_{r+1}}{\\operatorname*{\\longleftarrow}}worker\\quad r+1</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.5443em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">or</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">er</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mord\"><span class=\"mop op-limits\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.3499em;\"><span style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span><span class=\"mop\"><span class=\"mop\"><span class=\"mord mathrm\">⟵</span></span></span></span></span><span style=\"top:-3.7638em;margin-left:0em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03148em;\">k</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3173em;\"><span style=\"top:-2.357em;margin-left:-0.0315em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2025em;\"><span></span></span></span></span></span></span><span class=\"mpunct mtight\">,</span><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.03588em;\">v</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3173em;\"><span style=\"top:-2.357em;margin-left:-0.0359em;margin-right:0.0714em;\"><span class=\"pstrut\" style=\"height:2.5em;\"></span><span class=\"sizing reset-size3 size1 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">r</span><span class=\"mbin mtight\">+</span><span class=\"mord mtight\">1</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.2025em;\"><span></span></span></span></span></span></span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.011em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">or</span><span class=\"mord mathnormal\" style=\"margin-right:0.03148em;\">k</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">er</span><span class=\"mspace\" style=\"margin-right:1em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span>的覆盖，实现依赖于P2P的通信模式。</p>\n<p></p>\n<h4>Loadbalanced scheduling with communication and computation overlap</h4>\n<p>huggingface中采用的Recomputation的检查点放置不合理，导致相对高的还原计算代价。<br>\n下面是两种重计算策略的对比：<br>\n</p>\n<p>DFA相较HF每一个<code>FlashAttention</code>+<code>FFN</code>约能够减少一个FA的计算量。<br>\n<code>FlashAttention</code>部分的梯度更新为<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>K</mi><mi>Q</mi><mi>V</mi></mrow><annotation encoding=\"application/x-tex\">K Q V</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8778em;vertical-align:-0.1944em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">K</span><span class=\"mord mathnormal\">Q</span><span class=\"mord mathnormal\" style=\"margin-right:0.22222em;\">V</span></span></span></span>三个矩阵，可以通过FA的输出结果完成更新，因此保存FA的结果便可计算三者的矩阵。</p>\n",
      "date_published": "2024-10-28T00:00:00.000Z",
      "date_modified": "2025-01-23T13:43:11.000Z",
      "authors": [],
      "tags": [
        "SOSD"
      ]
    },
    {
      "title": "阶乘的位数估算--数学在计算机算法研究中的作用",
      "url": "https://newzone.top/posts/factorial_Stirling.html",
      "id": "https://newzone.top/posts/factorial_Stirling.html",
      "summary": "题目引入 算法与数据结构实验题 1.10 单身狗进化 这一天晚上，弯通又做梦了，并且梦到了一个帅气的男孩纸！这个男孩给了弯通一个数字 n。男孩离开前告诉弯通，n!（n 的阶乘）的位数就是距离弯通脱单的天数。矜（ji）持（ke）的弯通想知道自己还有多久能脱单，快写个程序帮助他！ 输入: 输入第一行为一个正整数 n（1<=n<=25000）。 输出: n阶...",
      "content_html": "<h2>题目引入</h2>\n<blockquote>\n<p>算法与数据结构实验题 1.10 单身狗进化\n这一天晚上，弯通又做梦了，并且梦到了一个帅气的男孩纸！这个男孩给了弯通一个数字 n。男孩离开前告诉弯通，n!（n 的阶乘）的位数就是距离弯通脱单的天数。矜（ji）持（ke）的弯通想知道自己还有多久能脱单，快写个程序帮助他！<br>\n输入:<br>\n输入第一行为一个正整数 n（1&lt;=n&lt;=25000）。<br>\n输出:<br>\nn阶乘的位数</p>\n</blockquote>\n<h2>题目分析</h2>\n<p>这道题看上去还挺有意思的<s>很符合大学生的心理状态</s>, 实际上就是要求阶乘的位数<s>倒也没有拐弯抹角</s>.<br>\n但是我们都知道, 要是用<code>递归</code>或者<code>循环</code>写阶乘, 这将是一件极为恐怖的事情.<br>\n在数据存储(空间复杂度)&amp;计算用时(时间复杂度)上的开销, 将成为任何一台机器的噩梦, 更不可能过测试了.<br>\n举个栗子:</p>\n<div class=\"language-用循环计算阶乘 line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"用循环计算阶乘\" data-title=\"用循环计算阶乘\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span>    int n;</span></span>\n<span class=\"line\"><span>    long long ans = 1;</span></span>\n<span class=\"line\"><span>    std::cin &gt;&gt; n;</span></span>\n<span class=\"line\"><span>    for (int i = 1; i &lt; MAX; i++)</span></span>\n<span class=\"line\"><span>        ans *= i;</span></span>\n<span class=\"line\"><span>    std::cout &lt;&lt; ans;</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><p>大家可以简单跑一下这个程序, 然后就会发现, 在<code>n = 27</code>的时候, 就已经溢出了, 完全无法满足题目要求.<br>\n这就是第一种错误的可能, 忘记了估计数据规模, 随便算算就存爆了.</p>\n<p>还有一种可能, 就是采用高精度的算法, 将阶乘结果用表存储, 每个内存存有限位数据, 在乘法时做类似竖式乘法的高精度运算.</p>\n<p>这种方式能不能过这个题我没有试过<s>因为我懒</s>, 但是一般来说高精度阶乘的时间复杂度是<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>O</mi><mo stretchy=\"false\">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo stretchy=\"false\">)</mo></mrow><annotation encoding=\"application/x-tex\">O(n^{2})</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.0641em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mord mathnormal\">n</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.8141em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">2</span></span></span></span></span></span></span></span></span><span class=\"mclose\">)</span></span></span></span></p>\n<p>程序代码的复杂度和 <code>n = 25000</code> 所要存储的数据规模, 也会是比较大的开销.</p>\n<p>下文将介绍一种用数学方法巧妙估算阶乘结果规模的方式.</p>\n<h2>斯特林公式</h2>\n<p v-pre=\"\" class=\"katex-block\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>n</mi><mo stretchy=\"false\">!</mo><mo>≈</mo><msqrt><mrow><mn>2</mn><mi>π</mi><mi>n</mi></mrow></msqrt><mtext> </mtext><msup><mrow><mo fence=\"true\">(</mo><mfrac><mi>n</mi><mi>e</mi></mfrac><mo fence=\"true\">)</mo></mrow><mi>n</mi></msup></mrow><annotation encoding=\"application/x-tex\">\nn!\\approx {\\sqrt {2\\pi n}}\\,\\left({\\frac {n}{e}}\\right)^{n} \n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">!</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">≈</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.8903em;vertical-align:-0.686em;\"></span><span class=\"mord\"><span class=\"mord sqrt\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9561em;\"><span class=\"svg-align\" style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\" style=\"padding-left:0.833em;\"><span class=\"mord\">2</span><span class=\"mord mathnormal\">πn</span></span></span><span style=\"top:-2.9161em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"hide-tail\" style=\"min-width:0.853em;height:1.08em;\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"400em\" height=\"1.08em\" viewBox=\"0 0 400000 1080\" preserveAspectRatio=\"xMinYMin slice\"><path d=\"M95,702\nc-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14\nc0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54\nc44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10\ns173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429\nc69,-144,104.5,-217.7,106.5,-221\nl0 -0\nc5.3,-9.3,12,-14,20,-14\nH400000v40H845.2724\ns-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7\nc-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z\nM834 80h400000v40h-400000z\"></path></svg></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.0839em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"minner\"><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size2\">(</span></span><span class=\"mord\"><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.1076em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">e</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size2\">)</span></span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.2043em;\"><span style=\"top:-3.6029em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span></span></span></span></span></span></span></span></span></span></p>\n<p>这个公式以<code>詹姆斯·斯特林</code>的名字命名，虽然<code>亚伯拉罕·棣美弗</code>早于斯特林提出了一个类似的公式，但结果较不精确.<br>\n当n很大的时候，n阶乘的计算量十分大，所以斯特林公式十分好用，而且，即使在n很小的时候，斯特林公式的取值已经十分准确.</p>\n<p>可以通过计算对比来估计一下斯特林公式算出结果, 和阶乘计算结果的误差程度.</p>\n<p></p>\n<p>我们可以看到, 随着n的增大, 斯特林公式估算的误差已经降到了十万分之一以下, 这对估算阶乘的规模来说是完全可以接受的误差.</p>\n<p>通过斯特林公式我们可以简单估算阶乘的位数, 我们知道对于一个n进制数x, 都可以对其取$ [\\log_{n}x] + 1 $来得到这个n进制数的位数, 我们将进一步推导<code>用斯特林公式估算阶乘位数N</code>的公式.</p>\n<p v-pre=\"\" class=\"katex-block\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>N</mi><mo>=</mo><mo stretchy=\"false\">[</mo><mi>l</mi><mi>o</mi><msub><mi>g</mi><mn>10</mn></msub><mo stretchy=\"false\">[</mo><msqrt><mrow><mn>2</mn><mi>π</mi><mi>n</mi></mrow></msqrt><mtext> </mtext><msup><mrow><mo fence=\"true\">(</mo><mfrac><mi>n</mi><mi>e</mi></mfrac><mo fence=\"true\">)</mo></mrow><mi>n</mi></msup><mo stretchy=\"false\">]</mo><mo stretchy=\"false\">]</mo><mo>+</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">\nN = [log_{10}[{\\sqrt {2\\pi n}}\\,\\left({\\frac {n}{e}}\\right)^{n}]] + 1 \n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.8903em;vertical-align:-0.686em;\"></span><span class=\"mopen\">[</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">10</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">[</span><span class=\"mord\"><span class=\"mord sqrt\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.9561em;\"><span class=\"svg-align\" style=\"top:-3em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\" style=\"padding-left:0.833em;\"><span class=\"mord\">2</span><span class=\"mord mathnormal\">πn</span></span></span><span style=\"top:-2.9161em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"hide-tail\" style=\"min-width:0.853em;height:1.08em;\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"400em\" height=\"1.08em\" viewBox=\"0 0 400000 1080\" preserveAspectRatio=\"xMinYMin slice\"><path d=\"M95,702\nc-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14\nc0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54\nc44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10\ns173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429\nc69,-144,104.5,-217.7,106.5,-221\nl0 -0\nc5.3,-9.3,12,-14,20,-14\nH400000v40H845.2724\ns-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7\nc-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z\nM834 80h400000v40h-400000z\"></path></svg></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.0839em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"mspace\" style=\"margin-right:0.1667em;\"></span><span class=\"minner\"><span class=\"minner\"><span class=\"mopen delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size2\">(</span></span><span class=\"mord\"><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.1076em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">e</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span></span><span class=\"mclose delimcenter\" style=\"top:0em;\"><span class=\"delimsizing size2\">)</span></span></span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.2043em;\"><span style=\"top:-3.6029em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mathnormal mtight\">n</span></span></span></span></span></span></span></span></span><span class=\"mclose\">]]</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span></span></p>\n<p>其中内层中括号标记运算顺序, 外层中括号意为高斯取整(即向下取整).</p>\n<p v-pre=\"\" class=\"katex-block\"><span class=\"katex-display\"><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\" display=\"block\"><semantics><mrow><mi>N</mi><mo>=</mo><mo stretchy=\"false\">[</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mi>l</mi><mi>o</mi><msub><mi>g</mi><mn>10</mn></msub><mo stretchy=\"false\">(</mo><mn>2</mn><mi>π</mi><mi>n</mi><mo stretchy=\"false\">)</mo><mo>+</mo><mi>n</mi><mi>l</mi><mi>o</mi><msub><mi>g</mi><mn>10</mn></msub><mo stretchy=\"false\">(</mo><mfrac><mi>n</mi><mi>e</mi></mfrac><mo stretchy=\"false\">)</mo><mo stretchy=\"false\">]</mo><mo>+</mo><mn>1</mn></mrow><annotation encoding=\"application/x-tex\">\nN = [\\frac{1}{2}log_{10}(2\\pi n) + nlog_{10}(\\frac{n}{e})] + 1 \n</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6833em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:2.0074em;vertical-align:-0.686em;\"></span><span class=\"mopen\">[</span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.3214em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">2</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord\">1</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">10</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\">2</span><span class=\"mord mathnormal\">πn</span><span class=\"mclose\">)</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.7936em;vertical-align:-0.686em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">o</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3011em;\"><span style=\"top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">10</span></span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mopen\">(</span><span class=\"mord\"><span class=\"mopen nulldelimiter\"></span><span class=\"mfrac\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:1.1076em;\"><span style=\"top:-2.314em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">e</span></span></span><span style=\"top:-3.23em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"frac-line\" style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span class=\"pstrut\" style=\"height:3em;\"></span><span class=\"mord\"><span class=\"mord mathnormal\">n</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.686em;\"><span></span></span></span></span></span><span class=\"mclose nulldelimiter\"></span></span><span class=\"mclose\">)]</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span><span class=\"mbin\">+</span><span class=\"mspace\" style=\"margin-right:0.2222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.6444em;\"></span><span class=\"mord\">1</span></span></span></span></span></p>\n<p>通过代入n, 即可轻松求得<span v-pre=\"\" class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>n</mi><mo stretchy=\"false\">!</mo></mrow><annotation encoding=\"application/x-tex\">n!</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.6944em;\"></span><span class=\"mord mathnormal\">n</span><span class=\"mclose\">!</span></span></span></span>的位数, 时间复杂度是梦寐以求的O(1), 即常数时间复杂度.</p>\n<h2>代码实现</h2>\n<p>代码实现没什么好说的, 套公式罢了, 由于我之前已经测试过最大数据规模, 所以<code>ans</code>也是为了省事儿用的<code>int</code><s>偷懒是可耻的</s></p>\n<div class=\"language- line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"\" data-title=\"\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span>  #include &lt;stdio.h&gt;</span></span>\n<span class=\"line\"><span>  #include &lt;math.h&gt;</span></span>\n<span class=\"line\"><span></span></span>\n<span class=\"line\"><span>  #define PI 3.141592654</span></span>\n<span class=\"line\"><span>  #define E 2.71828182846</span></span>\n<span class=\"line\"><span></span></span>\n<span class=\"line\"><span>  int pos(int n)</span></span>\n<span class=\"line\"><span>  {</span></span>\n<span class=\"line\"><span>      int s = 1;</span></span>\n<span class=\"line\"><span>      if(n &gt; 3)</span></span>\n<span class=\"line\"><span>          s = log10(2*PI*n) / 2 + n * log10(n/E) + 1;</span></span>\n<span class=\"line\"><span>      return s;</span></span>\n<span class=\"line\"><span>  }</span></span>\n<span class=\"line\"><span></span></span>\n<span class=\"line\"><span>  int main()</span></span>\n<span class=\"line\"><span>  {</span></span>\n<span class=\"line\"><span>      int num, ans;</span></span>\n<span class=\"line\"><span>      scanf(\"%d\", &amp;num);</span></span>\n<span class=\"line\"><span>      ans = pos(num);</span></span>\n<span class=\"line\"><span>      printf(\"%d\", ans);</span></span>\n<span class=\"line\"><span>  }</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h2>总结</h2>\n<blockquote>\n<p>数即一切</p>\n</blockquote>\n",
      "date_published": "2024-09-17T00:00:00.000Z",
      "date_modified": "2024-09-17T08:16:53.000Z",
      "authors": [],
      "tags": [
        "数据结构与算法"
      ]
    },
    {
      "title": "ACM Try -- 01",
      "url": "https://newzone.top/posts/vjudge_solutions_1.html",
      "id": "https://newzone.top/posts/vjudge_solutions_1.html",
      "summary": "1. Dragon String (龙字符串) 题目描述 给定一个正整数N，要求输出一个特定的字符串，该字符串由一个'L'、N个'o'、一个'n'和一个'g'按顺序组成。 约束条件 1 ≤ N ≤ 2024 N为整数 解题思路 这是一道简单的字符串构造题，主要考察基础的字符串操作和循环控制。解题步骤如下： 读取输入整数N 输出字符'L' 循环N次输出字...",
      "content_html": "<h2>1. Dragon String (龙字符串)</h2>\n<h3>题目描述</h3>\n<p>给定一个正整数N，要求输出一个特定的字符串，该字符串由一个'L'、N个'o'、一个'n'和一个'g'按顺序组成。</p>\n<h3>约束条件</h3>\n<ul>\n<li>1 ≤ N ≤ 2024</li>\n<li>N为整数</li>\n</ul>\n<h3>解题思路</h3>\n<p>这是一道简单的字符串构造题，主要考察基础的字符串操作和循环控制。解题步骤如下：</p>\n<ol>\n<li>读取输入整数N</li>\n<li>输出字符'L'</li>\n<li>循环N次输出字符'o'</li>\n<li>最后输出字符'n'和'g'</li>\n</ol>\n<h3>易错点</h3>\n<ol>\n<li>输出字符的大小写问题：'L'必须是大写，'o'、'n'、'g'必须是小写</li>\n<li>循环次数控制：容易多输出或少输出一个'o'</li>\n<li>输出顺序：必须严格按照L-&gt;o-&gt;n-&gt;g的顺序</li>\n</ol>\n<h3>代码实现</h3>\n<div class=\"language-cpp line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"cpp\" data-title=\"cpp\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;bits/stdc++.h&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">using</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> namespace</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#E5C07B\"> std</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> main</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">() {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> n;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    cin </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> n;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    cout </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;&lt;</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> 'L'</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    while</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (n</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">--</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> &gt;</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        cout </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;&lt;</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> 'o'</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    cout </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;&lt;</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> 'n'</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> &lt;&lt;</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> 'g'</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    return</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">}</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3>复杂度分析</h3>\n<ul>\n<li>时间复杂度：O(N)</li>\n<li>空间复杂度：O(1)</li>\n</ul>\n<h2>2. YES字符串判断</h2>\n<h3>题目描述</h3>\n<p>给定T个测试用例，每个用例包含一个字符串，判断该字符串是否等于\"YES\"（不区分大小写）。</p>\n<h3>约束条件</h3>\n<ul>\n<li>1 ≤ T ≤ 103</li>\n<li>输入字符串只包含大小写英文字母</li>\n</ul>\n<h3>解题思路</h3>\n<p>这是一道字符串比较题，主要考察字符串处理和大小写转换。解题要点：</p>\n<ol>\n<li>将输入字符串转换为小写</li>\n<li>与标准字符串\"yes\"比较</li>\n<li>注意处理大小写不敏感的比较</li>\n</ol>\n<h3>易错点</h3>\n<ol>\n<li>输入字符串长度未判断：虽然题目保证输入合法，但在实际工程中应该加上长度判断</li>\n<li>输出大小写问题：输出\"YES\"或\"NO\"时必须全部大写</li>\n<li>字符串比较前的转换：必须先将输入字符串转换为小写，再进行比较</li>\n<li>返回值处理：main函数末尾漏掉return 0</li>\n</ol>\n<h3>代码实现</h3>\n<div class=\"language-cpp line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"cpp\" data-title=\"cpp\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;bits/stdc++.h&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;cctype&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;cstdio&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">using</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> namespace</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#E5C07B\"> std</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> main</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">() {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> n;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    cin </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> n;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    string boolstr;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    while</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (n </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">--</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> &gt;</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        cin </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> boolstr;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">        // 将整个字符串转换为小写</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        for</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">char</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#56B6C2\"> &amp;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">c : boolstr) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">            c </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> tolower</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(c);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        if</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (boolstr </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">==</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> \"yes\"</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">            printf</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"YES</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">\\n</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        } </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">else</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">            printf</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"NO</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">\\n</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">}</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3>复杂度分析</h3>\n<ul>\n<li>时间复杂度：O(T×L)，其中L为字符串长度</li>\n<li>空间复杂度：O(1)</li>\n</ul>\n<h2>3. 奇偶判断</h2>\n<h3>题目描述</h3>\n<p>给定N个大整数，判断每个数的奇偶性。</p>\n<h3>约束条件</h3>\n<ul>\n<li>1 ≤ N ≤ 100</li>\n<li>输入整数不超过10^60</li>\n</ul>\n<h3>解题思路</h3>\n<p>这是一道大数处理题，但有一个重要的数学性质：一个数的奇偶性只取决于其最后一位数字。因此：</p>\n<ol>\n<li>将输入数字以字符串形式读入</li>\n<li>只需判断最后一个字符对应的数字的奇偶性</li>\n<li>无需进行完整的大数运算</li>\n</ol>\n<h3>易错点</h3>\n<ol>\n<li>大数处理方式：试图将输入转换为整数类型会导致溢出</li>\n<li>字符转数字：忘记将字符转换为数字（减去'0'）就直接判断</li>\n<li>输出格式：输出\"odd\"或\"even\"时必须全部小写</li>\n<li>边界情况：没有考虑输入为单个数字的情况</li>\n</ol>\n<h3>代码实现</h3>\n<div class=\"language-cpp line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"cpp\" data-title=\"cpp\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;bits/stdc++.h&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">using</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> namespace</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#E5C07B\"> std</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> main</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">() {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> n;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    cin </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> n;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    string num;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    while</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (n</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">--</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> &gt;</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        cin </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> num;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\">        // 只需要检查最后一位数字即可判断奇偶性</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        if</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> ((</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">num</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">back</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">() </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">-</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> '0'</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">%</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 2</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> ==</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 1</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">            cout </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;&lt;</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> \"odd</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">\\n</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        else</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">            cout </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;&lt;</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> \"even</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">\\n</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    return</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">}</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3>复杂度分析</h3>\n<ul>\n<li>时间复杂度：O(N)</li>\n<li>空间复杂度：O(1)</li>\n</ul>\n<h2>4. 字符统计问题</h2>\n<h3>题目描述</h3>\n<p>给定一个字符串和目标次数m，需要计算使每个字符出现次数达到m次所需添加的最少字符数。</p>\n<h3>解题思路</h3>\n<p>这是一道哈希统计题，主要思路如下：</p>\n<ol>\n<li>使用哈希数组统计每个字符的出现次数</li>\n<li>对于每个字符，计算需要补充多少个才能达到目标次数m</li>\n<li>累加所有需要补充的字符数</li>\n</ol>\n<h3>易错点</h3>\n<ol>\n<li>哈希数组大小：vector初始化大小必须足够存储所有可能的字符</li>\n<li>字符映射：将字符转换为数组下标时的计算可能越界</li>\n<li>补充计算：当字符出现次数已经超过m时，不需要再补充</li>\n<li>测试用例处理：忘记处理多组测试用例的情况</li>\n</ol>\n<h3>代码实现</h3>\n<div class=\"language-cpp line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"cpp\" data-title=\"cpp\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;bits/stdc++.h&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">using</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> namespace</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#E5C07B\"> std</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> main</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">() {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> cnt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    cin </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> cnt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    while</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (cnt </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">--</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> &gt;</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> m, n;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> count </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        cin </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> n </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> m;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        string line;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        vector</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;int&gt;</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> hash</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">7</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        cin </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> line;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        for</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">auto</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#56B6C2\"> &amp;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">ch : line) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">            hash</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">Hash</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(ch </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">-</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> 'A'</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">))]</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        for</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">auto</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> k : hash) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">            if</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (m </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> k)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">                count </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">+=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> m </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">-</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> k;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">        printf</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">%d</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">\\n</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">, count);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    return</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">}</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3>复杂度分析</h3>\n<ul>\n<li>时间复杂度：O(T×N)，其中T为测试用例数，N为字符串长度</li>\n<li>空间复杂度：O(1)，因为哈希数组大小固定</li>\n</ul>\n<h2>5. 投票统计</h2>\n<h3>题目描述</h3>\n<p>给定n个人在m天内对规则k的投票情况，判断规则k是否符合民意。规则符合民意的条件是：在过半数的天数中，有过半数的人支持该规则。</p>\n<h3>解题思路</h3>\n<p>这是一道二维统计题，需要两层判断：</p>\n<ol>\n<li>对每一天统计支持规则k的人数，判断是否过半</li>\n<li>统计符合条件的天数是否过半</li>\n<li>使用排序来简化判断过半的操作</li>\n</ol>\n<h3>易错点</h3>\n<ol>\n<li>过半数计算：(n+1)/2 而不是 n/2，需要考虑奇数情况</li>\n<li>数组初始化：right数组的大小应该是m而不是当前的m值（因为m在循环中会减少）</li>\n<li>排序后的判断：需要判断right[0]和right[(days-1)/2]，而不是简单统计1的个数</li>\n<li>变量保存：需要保存原始的m值用于最后判断</li>\n</ol>\n<h3>代码实现</h3>\n<div class=\"language-cpp line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"cpp\" data-title=\"cpp\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;bits/stdc++.h&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">using</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> namespace</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#E5C07B\"> std</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> main</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">() {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> n, m, k;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    cin </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> n </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> m </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> k;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    vector</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;int&gt;</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> right</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(m, </span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> days </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> m;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    while</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (m </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">--</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> &gt;</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> cnt </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> num </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        for</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> n; i</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">            cin </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> num;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">            if</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (num </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">==</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> k)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">                cnt</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        if</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (cnt </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (n </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">+</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 1</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">/</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 2</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">            right</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[m] </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 1</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">    sort</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">right</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">begin</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(), </span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">right</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">.</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">end</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(), [](</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> x</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">, </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic\"> y</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">){</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">return</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> x </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> y;});</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    if</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">right</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">] </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">==</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 1</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#56B6C2\"> &amp;&amp;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\"> right</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[(days </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">-</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 1</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">/</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 2</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">] </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">==</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 1</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">)</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">        printf</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"YES\"</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    else</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">        printf</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">\"NO\"</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    return</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">}</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3>复杂度分析</h3>\n<ul>\n<li>时间复杂度：O(M×N + MlogM)</li>\n<li>空间复杂度：O(M)</li>\n</ul>\n<h2>6. 字符替换</h2>\n<h3>题目描述</h3>\n<p>给定一个字符串S和Q次操作，每次操作将字符串中的某个字符全部替换为另一个字符。</p>\n<h3>解题思路</h3>\n<p>这是一道字符串模拟题，主要考察字符串的遍历和替换操作：</p>\n<ol>\n<li>读入初始字符串</li>\n<li>对每次操作，遍历整个字符串进行替换</li>\n<li>注意替换操作要同时进行，避免连锁反应</li>\n</ol>\n<h3>易错点</h3>\n<ol>\n<li>替换顺序：每次操作必须同时替换所有匹配的字符，不能边替换边比较</li>\n<li>自身替换：当c和d相同时也需要正确处理</li>\n<li>字符串修改：使用引用或指针修改字符串时的正确性</li>\n<li>输出格式：最后需要输出换行符</li>\n</ol>\n<h3>代码实现</h3>\n<div class=\"language-cpp line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"cpp\" data-title=\"cpp\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;iostream&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;string&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">using</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> namespace</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#E5C07B\"> std</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> main</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">() {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> N;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    string S;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> Q;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    cin </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> N </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> S </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> Q;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    for</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> Q; i</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        char</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> c, d;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        cin </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> c </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> d;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        for</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> j </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; j </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> N; j</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">            if</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">S</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[j] </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">==</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> c) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">                S</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[j] </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> d;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">            }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    cout </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> S </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> endl;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    return</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">}</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3>复杂度分析</h3>\n<ul>\n<li>时间复杂度：O(Q×N)</li>\n<li>空间复杂度：O(N)</li>\n</ul>\n<h2>7. 矩阵操作</h2>\n<h3>题目描述</h3>\n<p>给定一个n×n的矩阵和m次操作，每次操作可以交换两行或两列。</p>\n<h3>解题思路</h3>\n<p>这是一道矩阵模拟题，但有一个优化技巧：</p>\n<ol>\n<li>不直接修改矩阵，而是维护行列的映射关系</li>\n<li>每次交换只需要修改映射数组</li>\n<li>最后输出时根据映射关系重建矩阵</li>\n</ol>\n<h3>易错点</h3>\n<ol>\n<li>下标转换：输入的行列号从1开始，需要减1后再使用</li>\n<li>映射数组初始化：必须正确初始化row和col数组为0到n-1</li>\n<li>矩阵访问：输出时使用映射数组访问matrix[row[i]][col[j]]而不是直接访问</li>\n<li>输出格式：最后一个数字后不能有空格，需要换行</li>\n</ol>\n<h3>代码实现</h3>\n<div class=\"language-cpp line-numbers-mode\" data-highlighter=\"shiki\" data-ext=\"cpp\" data-title=\"cpp\" style=\"--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34\"><pre class=\"shiki shiki-themes github-light one-dark-pro vp-code\"><code><span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;iostream&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">#include</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> &lt;vector&gt;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">using</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> namespace</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#E5C07B\"> std</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> main</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">() {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> n, m;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    cin </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> n </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> m;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    vector</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">vector</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;int&gt;&gt;</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> matrix</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(n, </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">vector</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&lt;</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">&gt;(n));</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    for</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> n; i</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        for</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> j </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; j </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> n; j</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">            cin </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\"> matrix</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[i][j];</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    vector</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;int&gt;</span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\"> row</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(n), </span><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">col</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(n);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    for</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> n; i</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">        row</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[i] </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> i;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">        col</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[i] </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> i;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    for</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> m; i</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> op, x, y;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        cin </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> op </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> x </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&gt;&gt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> y;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        x</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">--</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; y</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">--</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        if</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (op </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">==</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 1</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">            swap</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">row</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[x], </span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">row</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[y]);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        } </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">else</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#6F42C1;--shiki-dark:#61AFEF\">            swap</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">(</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">col</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[x], </span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">col</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[y]);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    for</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; i </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> n; i</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">        for</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">int</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> j </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">=</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">; j </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> n; j</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">++</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">) {</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">            cout </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\"> matrix</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">row</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[i]][</span><span style=\"--shiki-light:#24292E;--shiki-dark:#E5C07B\">col</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">[j]] </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">&lt;&lt;</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> (j </span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">==</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\"> n</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">-</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\">1</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> ?</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> '</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#56B6C2\">\\n</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\">'</span><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\"> :</span><span style=\"--shiki-light:#032F62;--shiki-dark:#98C379\"> ' '</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">);</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">        }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">    }</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#D73A49;--shiki-dark:#C678DD\">    return</span><span style=\"--shiki-light:#005CC5;--shiki-dark:#D19A66\"> 0</span><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">;</span></span>\n<span class=\"line\"><span style=\"--shiki-light:#24292E;--shiki-dark:#ABB2BF\">}</span></span></code></pre>\n<div class=\"line-numbers\" aria-hidden=\"true\" style=\"counter-reset:line-number 0\"><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div><div class=\"line-number\"></div></div></div><h3>复杂度分析</h3>\n<ul>\n<li>时间复杂度：O(n² + m)</li>\n<li>空间复杂度：O(n²)</li>\n</ul>\n<h2>总结</h2>\n<p>这组题目涵盖了多个基础算法知识点：</p>\n<ol>\n<li>字符串处理（题目1、2、6）</li>\n<li>大数处理技巧（题目3）</li>\n<li>哈希统计（题目4）</li>\n<li>二维统计与排序（题目5）</li>\n<li>矩阵操作与状态维护（题目7）</li>\n</ol>\n<p>每道题都体现了一些重要的编程思想：</p>\n<ul>\n<li>善用数学性质简化问题（题目3）</li>\n<li>使用哈希表优化统计（题目4）</li>\n<li>排序简化判断（题目5）</li>\n<li>状态映射代替直接修改（题目7）</li>\n</ul>\n<p>这些思想在更复杂的算法题中都会经常用到。</p>\n",
      "date_published": "2024-01-23T00:00:00.000Z",
      "date_modified": "2025-01-23T13:51:07.000Z",
      "authors": [],
      "tags": [
        "算法与数据结构"
      ]
    }
  ]
}